<!DOCTYPE html>
<html lang="et">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Rütmiharjutuste generaator (beeta)</title>

  <style>
    :root {
      --bg: #f6f8ff;
      --card: #ffffff;
      --ink: #1f2937;
      --muted: #6b7280;
      --accent: #3b82f6;
      --border: #e5e7eb;
    }

    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      color: var(--ink);
      background: radial-gradient(1200px 500px at 10% 0%, #eef2ff 0%, var(--bg) 55%, #fff7ed 120%);
      max-width: 1200px;
      margin: 22px auto;
      padding: 0 14px 40px;
      line-height: 1.35;
    }

    header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    h1 {
      margin: 6px 0 4px;
      font-size: 1.6rem;
      letter-spacing: -0.02em;
    }

    .tagline {
      display: inline-block;
      margin-top: 4px;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,0.7);
      border: 1px solid var(--border);
      color: #4b5563;
      font-size: 0.95rem;
    }

    .layout {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 10px;
    }

    @media (min-width: 880px) {
      .layout {
        grid-template-columns: 320px minmax(0, 1fr);
        align-items: start;
      }
    }

    /* Kontrollide peitmine (täisekraan režiim) */
    .layout.controls-hidden .controls {
      display: none;
    }

    .layout.controls-hidden {
      grid-template-columns: 1fr;
    }

    /* Peidame ka headeri, kui kontrollid on peidetud */
    .controls-hidden header > div {
      display: none;
    }

    /* Nupp on tavaliselt headeris */
    #btnToggleUI {
      white-space: nowrap;
    }

    /* Kui kontrollid on peidetud, liigub nupp fixed positsioonile */
    .controls-hidden #btnToggleUI {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* Peida esituse kontrollid täisekraanis kui checkbox pole märgitud */
    body.controls-hidden #playbackControls.hidden-in-fullscreen {
      display: none !important;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 14px 30px rgba(17, 24, 39, 0.08);
      padding: 12px;
    }

    .card.paper {
      padding: 10px;
    }

    .controls h2 {
      margin: 0 0 8px;
      font-size: 1rem;
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    label.chk {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 8px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(255,255,255,0.75);
      cursor: pointer;
      transition: background 120ms ease;
    }

    label.chk:hover {
      background: rgba(255,255,255,0.95);
    }

    label.chk input { transform: scale(1.1); flex-shrink: 0; }
    
    /* ÜHTLUSTATUD RÜTMIPILTIDE SUURUS */
    label.chk svg { 
      flex-shrink: 0;
      height: 40px !important;
      width: auto !important;
      max-width: 100px;
    }
    label.chk svg { flex-shrink: 0; }

    .muted { color: var(--muted); }

    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.85);
      font-size: 0.95rem;
    }

    .btnbar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    button {
      font-size: 1rem;
      padding: 10px 14px;
      cursor: pointer;
      border: 0;
      border-radius: 14px;
      color: white;
      background: linear-gradient(135deg, var(--accent), #22c55e);
      box-shadow: 0 10px 22px rgba(59, 130, 246, 0.18);
      transition: transform 120ms ease, box-shadow 120ms ease;
    }

    button:hover { transform: translateY(-1px); box-shadow: 0 14px 28px rgba(59, 130, 246, 0.22); }
    button:active { transform: translateY(0px); box-shadow: 0 10px 22px rgba(59, 130, 246, 0.16); }

    button.secondary {
      background: #111827;
      box-shadow: 0 10px 22px rgba(17, 24, 39, 0.12);
    }

    button.ghost {
      background: rgba(255,255,255,0.75);
      color: #111827;
      border: 1px solid var(--border);
      box-shadow: none;
    }

    #paper { overflow-x: auto; }
    #paper svg {
      display: block;
      max-width: 100%;
      height: auto;
    }

    .small {
      margin-top: 16px;
      font-size: 0.98rem;
      color: var(--muted);
    }

    /* PRINT */
    @media print {
      @page { margin: 12mm; }
      body { background: white; margin: 0; max-width: none; padding: 0; }
      header, .controls, #playbackControls { display: none !important; }
      .card { box-shadow: none; border: 0; padding: 0; }
      .layout { grid-template-columns: 1fr; }
      #paper { overflow: visible; }
      #paper svg { width: 100% !important; height: auto !important; }
      #paper > div:not(:first-child) { page-break-before: avoid; margin-top: 30px; }
    }
  </style>
</head>
<body>

  <header>
    <div>
      <h1>Rütmiharjutuste generaator (beeta)</h1>
      <div class="tagline">Vali rütmid, taktimõõt ja pikkus – siis genereeri uus harjutus.</div>
    </div>
    <button id="btnToggleUI" type="button" class="ghost" style="align-self: flex-start;">⚙️ Peida kontrollid</button>
  </header>

  <div class="layout">

    <section class="card controls">
      <h2>Sisu</h2>
      <div class="grid" style="margin-bottom: 6px;">
        <!-- ta - veerand (täidetud noodipea + vars) -->
        <label class="chk">
          <input type="checkbox" id="tok_ta" checked />
          <svg width="40" height="30" viewBox="320 610 80 130" xmlns="http://www.w3.org/2000/svg">
            <path transform="matrix(0.992126,0,0,0.992126,325.64,721.063)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="356.51,717.888 356.51,634.252"/>
          </svg>
        </label>

        <!-- ta-a - poolnoot (õõnes noodipea + vars, 2 lööki) -->
        <label class="chk">
          <input type="checkbox" id="tok_taa" />
          <svg width="40" height="30" viewBox="445 610 80 130" xmlns="http://www.w3.org/2000/svg">
            <path transform="matrix(0.992126,0,0,0.992126,444.986,696.26)" d="M31.5,-8.14063 C29.7031,-11.4375 25.9063,-13.2344 21.2969,-13.2344 C17.9063,-13.2344 14.2031,-12.2344 10.5938,-10.3438 C4,-6.84375 0,-0.9375 0,4.15625 C0,5.5625 0.296875,6.96875 1,8.26563 C2.79688,11.5781 6.59375,13.2813 11.2031,13.2813 C14.5938,13.2813 18.2969,12.375 21.9063,10.4844 C28.5,6.96875 32.5,1.0625 32.5,-4.04688 C32.5,-5.4375 32.2031,-6.84375 31.5,-8.14063 M27.2031,-1.34375 C25.5,0.359375 22.0938,2.45313 18.5,4.46875 C14.9063,6.46875 11.2969,7.96875 8.90625,8.46875 C8.40625,8.57813 7.90625,8.67188 7.40625,8.67188 C5.79688,8.67188 4.59375,8.07813 3.90625,6.76563 C3.59375,6.26563 3.40625,5.67188 3.40625,5.0625 C3.40625,3.96875 4.09375,2.65625 5.20313,1.5625 C6.90625,-0.140625 10.2031,-2.23438 13.7969,-4.23438 C17.4063,-6.23438 21,-7.73438 23.4063,-8.23438 C23.9063,-8.34375 24.4063,-8.4375 24.9063,-8.4375 C26.5,-8.4375 27.7969,-7.84375 28.5,-6.54688 C28.7969,-6.04688 28.9063,-5.4375 28.9063,-4.84375 C28.9063,-3.73438 28.2969,-2.54688 27.2031,-1.34375"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="475.858,693.085 475.858,615.65"/>
          </svg>
        </label>

        <!-- ti-ti - 2 kaheksandikku beamiga -->
        <label class="chk">
          <input type="checkbox" id="tok_titi" checked />
          <svg width="60" height="30" viewBox="606 610 80 130" xmlns="http://www.w3.org/2000/svg">
            <path transform="matrix(0.992126,0,0,0.992126,575.177,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,616.838,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="606.049,693.085 606.049,628.051"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="647.71,693.085 647.71,628.051"/>
            <path fill-rule="evenodd" d="M604.685,621.85 L649.074,621.85 L649.074,634.252 L604.685,634.252 L604.685,621.85 "/>
          </svg>
        </label>

        <!-- ta-a-a - täisnoot (õõnes, ilma varreta, 4 lööki) -->
        <label class="chk">
          <input type="checkbox" id="tok_taaa" />
          <svg width="45" height="30" viewBox="280 610 80 130" xmlns="http://www.w3.org/2000/svg">
            <path transform="matrix(0.992126,0,0,0.992126,279.893,696.26)" d="M18.7031,-13.5938 C4.90625,-13.5938 0,-6.59375 0,-0.09375 C0,6.40625 4.90625,13.4063 18.7031,13.4063 C32.5,13.4063 37.2969,6.40625 37.2969,-0.09375 C37.2969,-6.59375 32.5,-13.5938 18.7031,-13.5938 M10.4063,-4.5 C10.2969,-4.90625 10.2969,-5.29688 10.2969,-5.70313 C10.2969,-6.5 10.5,-7.29688 10.9063,-8 C11.5938,-9 12.7969,-9.70313 14.2969,-10 C15.5938,-10.2969 16.2969,-10.5 18.9063,-10.5 L19,-10.5 C23,-10.5 24.2969,-6.79688 25.4063,-3 L25.7031,-2 C26.5,0.59375 26.9063,2.79688 26.9063,4.5 C26.9063,5.70313 26.7031,6.79688 26.2969,7.59375 C25.7031,8.70313 24.7031,9.40625 23,9.79688 C22.0938,10 20.5938,10.0938 20.5938,10.0938 C20.0938,10.0938 19.7031,10.2031 19.2969,10.2031 C16.0938,10.2031 14.0938,9 12.7031,4.70313 C11.5,1 11.2969,-0.09375 10.4063,-4.5"/>
          </svg>
        </label>

        <!-- ta-a-i - punkteeritud poolnoot (õõnes, kolmelöögiline) -->
        <label class="chk">
          <input type="checkbox" id="tok_taai" />
          <svg width="55" height="30" viewBox="356 610 90 130" xmlns="http://www.w3.org/2000/svg">
            <path transform="matrix(0.992126,0,0,0.992126,356.457,721.063)" d="M31.5,-8.14063 C29.7031,-11.4375 25.9063,-13.2344 21.2969,-13.2344 C17.9063,-13.2344 14.2031,-12.2344 10.5938,-10.3438 C4,-6.84375 0,-0.9375 0,4.15625 C0,5.5625 0.296875,6.96875 1,8.26563 C2.79688,11.5781 6.59375,13.2813 11.2031,13.2813 C14.5938,13.2813 18.2969,12.375 21.9063,10.4844 C28.5,6.96875 32.5,1.0625 32.5,-4.04688 C32.5,-5.4375 32.2031,-6.84375 31.5,-8.14063 M27.2031,-1.34375 C25.5,0.359375 22.0938,2.45313 18.5,4.46875 C14.9063,6.46875 11.2969,7.96875 8.90625,8.46875 C8.40625,8.57813 7.90625,8.67188 7.40625,8.67188 C5.79688,8.67188 4.59375,8.07813 3.90625,6.76563 C3.59375,6.26563 3.40625,5.67188 3.40625,5.0625 C3.40625,3.96875 4.09375,2.65625 5.20313,1.5625 C6.90625,-0.140625 10.2031,-2.23438 13.7969,-4.23438 C17.4063,-6.23438 21,-7.73438 23.4063,-8.23438 C23.9063,-8.34375 24.4063,-8.4375 24.9063,-8.4375 C26.5,-8.4375 27.7969,-7.84375 28.5,-6.54688 C28.7969,-6.04688 28.9063,-5.4375 28.9063,-4.84375 C28.9063,-3.73438 28.2969,-2.54688 27.2031,-1.34375"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="387.329,717.888 387.329,634.252"/>
            <path transform="matrix(0.992126,0,0,0.992126,401.095,721.063)" d="M0,0 C0,2.76563 2.23438,5 5,5 C7.76563,5 10,2.76563 10,0 C10,-2.76563 7.76563,-5 5,-5 C2.23438,-5 0,-2.76563 0,0"/>
          </svg>
        </label>

        <!-- ti-ri - 4 kuueteistkümnendiknoot -->
        <label class="chk">
          <input type="checkbox" id="tok_tiri" />
          <svg width="90" height="30" viewBox="1333 610 130 130" xmlns="http://www.w3.org/2000/svg">
            <path transform="matrix(0.992126,0,0,0.992126,1303.92,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,1341.12,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,1378.32,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,1415.51,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="1334.79,693.085 1334.79,615.65"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="1371.99,693.085 1371.99,615.65"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="1409.18,693.085 1409.18,615.65"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="1446.38,693.085 1446.38,615.65"/>
            <path fill-rule="evenodd" d="M1333.42,609.449 L1447.74,609.449 L1447.74,621.85 L1333.42,621.85 L1333.42,609.449 "/>
            <path fill-rule="evenodd" d="M1333.42,628.051 L1447.74,628.051 L1447.74,640.453 L1333.42,640.453 L1333.42,628.051 "/>
          </svg>
        </label>

        <!-- tai-ri - punkteeritud kaheksandik + kuueteistkümnendiknoot (MuseScore) -->
        <label class="chk">
          <input type="checkbox" id="tok_tairi" />
          <svg width="65" height="30" viewBox="356 610 310 130" xmlns="http://www.w3.org/2000/svg">
            <path transform="matrix(0.992126,0,0,0.992126,356.457,721.063)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,630.6,721.063)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="387.329,717.888 387.329,640.453"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="661.473,717.888 661.473,640.453"/>
            <path fill-rule="evenodd" d="M385.965,634.252 L662.837,634.252 L662.837,646.654 L385.965,646.654 L385.965,634.252 "/>
            <path fill-rule="evenodd" d="M662.837,652.854 L630.593,652.854 L630.593,665.256 L662.837,665.256 L662.837,652.854 "/>
            <path transform="matrix(0.992126,0,0,0.992126,401.095,721.063)" d="M0,0 C0,2.76563 2.23438,5 5,5 C7.76563,5 10,2.76563 10,0 C10,-2.76563 7.76563,-5 5,-5 C2.23438,-5 0,-2.76563 0,0"/>
          </svg>
        </label>

        <!-- triool - 3 kaheksandikku -->
        <label class="chk">
          <input type="checkbox" id="tok_triplet" />
          <svg width="90" height="40" viewBox="2032 570 160 180" xmlns="http://www.w3.org/2000/svg">
            <path transform="matrix(0.992126,0,0,0.992126,2032.1,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,2069.3,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,2106.5,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="2062.98,693.085 2062.98,621.85"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="2100.18,693.085 2100.18,621.85"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="2137.37,693.085 2137.37,621.85"/>
            <path fill-rule="evenodd" d="M2061.61,621.85 L2138.73,621.85 L2138.73,634.252 L2061.61,634.252 L2061.61,621.85 "/>
            <path d="M2103.11,588.607 C2105.23,587.935 2106.08,587.56 2107.15,586.842 C2109.28,585.451 2110.58,582.982 2110.58,580.451 C2110.58,576.185 2107.15,573.31 2102.12,573.31 C2097.22,573.31 2093.08,576.357 2093.08,580.06 C2093.08,581.904 2094.2,583.154 2095.9,583.154 C2097.39,583.154 2098.48,582.076 2098.48,580.592 C2098.48,579.826 2098.25,579.295 2097.53,578.576 C2097.08,578.17 2096.9,577.842 2096.9,577.529 C2096.9,576.451 2099.15,575.326 2101.26,575.326 C2104.28,575.326 2106.08,576.998 2106.08,579.779 C2106.08,583.795 2103.25,587.56 2100.23,587.56 C2100.09,587.56 2099.68,587.529 2099.2,587.482 C2097.89,587.389 2097.89,587.389 2097.62,587.389 C2096.62,587.389 2096.09,587.842 2096.09,588.654 C2096.09,589.373 2096.59,589.81 2097.39,589.81 C2097.62,589.81 2097.93,589.779 2098.29,589.732 C2098.92,589.592 2099.61,589.545 2100,589.545 C2102.12,589.545 2103.56,591.435 2103.56,594.232 C2103.56,596.389 2103.06,598.451 2102.08,600.17 C2100.73,602.592 2098.65,603.764 2095.73,603.764 C2093.22,603.764 2091.04,602.514 2091.04,601.06 C2091.04,600.576 2091.23,600.389 2091.95,600.076 C2093.25,599.498 2093.79,598.685 2093.79,597.467 C2093.79,595.889 2092.53,594.685 2090.92,594.685 C2088.98,594.685 2087.72,596.201 2087.72,598.545 C2087.72,602.92 2091.04,605.654 2096.45,605.654 C2103.25,605.654 2108.42,601.107 2108.42,595.076 C2108.42,593.467 2107.92,592.06 2106.98,590.935 C2105.98,589.779 2105.09,589.232 2103.11,588.607"/>
          </svg>
        </label>

        <!-- sünkoobid - lühike (16+8+16) JA pikk (8+veerand+8) koos ühes ikoonil -->
        <label class="chk">
          <input type="checkbox" id="tok_sync" />
          <svg width="120" height="30" viewBox="1430 610 600 130" xmlns="http://www.w3.org/2000/svg">
            <!-- PIKK sünkoop: 8th + quarter + 8th -->
            <path transform="matrix(0.992126,0,0,0.992126,1432.93,721.063)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,1645.26,721.063)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,1985,721.063)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="1463.8,717.888 1463.8,634.252"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="1676.13,717.888 1676.13,634.252"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="2015.87,717.888 2015.87,634.252"/>
            <path transform="matrix(0.992126,0,0,0.992126,1462.43,634.252)" d="M3.5,3.5 C3.40625,3.20313 2.5,-0.296875 2.5,-0.5 C2.40625,-0.90625 1.79688,-1.20313 1.29688,-1.20313 C0.59375,-1.20313 0,-0.59375 0,0.09375 L0,16.5 L0,22.7031 C0,23.2031 0.40625,23.5938 0.796875,23.7969 C5,25.0938 13.7031,30.6094 20.2031,41.7031 C22,44.7969 24.9063,49 24.9063,57.4063 C24.9063,64.6094 23.7969,72.2031 22,79.2031 C21.7031,80.3125 21.4063,81.3125 22.5,81.7031 C23.5938,82.1094 24,81.3125 24.4063,80.3125 C28,71.5 28.9063,62.2969 28.9063,56.1094 L28.9063,54.2031 C28.4063,41.2969 21,31.7969 21,31.7969 C21.2969,31.7969 11.7969,19.5 9.09375,15.2969 C5.40625,9.59375 3.59375,3.90625 3.5,3.5"/>
            <path transform="matrix(0.992126,0,0,0.992126,2014.51,634.252)" d="M3.5,3.5 C3.40625,3.20313 2.5,-0.296875 2.5,-0.5 C2.40625,-0.90625 1.79688,-1.20313 1.29688,-1.20313 C0.59375,-1.20313 0,-0.59375 0,0.09375 L0,16.5 L0,22.7031 C0,23.2031 0.40625,23.5938 0.796875,23.7969 C5,25.0938 13.7031,30.6094 20.2031,41.7031 C22,44.7969 24.9063,49 24.9063,57.4063 C24.9063,64.6094 23.7969,72.2031 22,79.2031 C21.7031,80.3125 21.4063,81.3125 22.5,81.7031 C23.5938,82.1094 24,81.3125 24.4063,80.3125 C28,71.5 28.9063,62.2969 28.9063,56.1094 L28.9063,54.2031 C28.4063,41.2969 21,31.7969 21,31.7969 C21.2969,31.7969 11.7969,19.5 9.09375,15.2969 C5.40625,9.59375 3.59375,3.90625 3.5,3.5"/>
            
            <!-- LÜHIKE sünkoop: 16th + 8th + 16th -->
            <g transform="translate(910,0)">
              <path transform="matrix(0.992126,0,0,0.992126,2341.19,721.063)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
              <path transform="matrix(0.992126,0,0,0.992126,2458.58,721.063)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
              <path transform="matrix(0.992126,0,0,0.992126,2646.39,721.063)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
              <polyline fill="none" stroke="#000000" stroke-width="2.73" points="2372.07,717.888 2372.07,640.453"/>
              <polyline fill="none" stroke="#000000" stroke-width="2.73" points="2489.45,717.888 2489.45,640.453"/>
              <polyline fill="none" stroke="#000000" stroke-width="2.73" points="2677.27,717.888 2677.27,640.453"/>
              <path fill-rule="evenodd" d="M2370.7,634.252 L2678.63,634.252 L2678.63,646.654 L2370.7,646.654 L2370.7,634.252 "/>
              <path fill-rule="evenodd" d="M2370.7,652.854 L2402.95,652.854 L2402.95,665.256 L2370.7,665.256 L2370.7,652.854 "/>
              <path fill-rule="evenodd" d="M2678.63,652.854 L2646.39,652.854 L2646.39,665.256 L2678.63,665.256 L2678.63,652.854 "/>
            </g>
          </svg>
        </label>

        <!-- ti-ri-ti - 16th + 16th + 8th (MuseScore) -->
        <label class="chk">
          <input type="checkbox" id="tok_tiriti" />
          <svg width="70" height="30" viewBox="356 610 280 130" xmlns="http://www.w3.org/2000/svg">
            <path transform="matrix(0.992126,0,0,0.992126,356.457,721.063)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,480.321,721.063)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,604.185,721.063)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="387.329,717.888 387.329,640.453"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="511.193,717.888 511.193,640.453"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="635.058,717.888 635.058,640.453"/>
            <path fill-rule="evenodd" d="M385.965,634.252 L636.422,634.252 L636.422,646.654 L385.965,646.654 L385.965,634.252 "/>
            <path fill-rule="evenodd" d="M385.965,652.854 L512.557,652.854 L512.557,665.256 L385.965,665.256 L385.965,652.854 "/>
          </svg>
        </label>

        <!-- ti-ti-ri - 16th + 8th + 16th (MuseScore) -->
        <label class="chk">
          <input type="checkbox" id="tok_titiri" />
          <svg width="80" height="30" viewBox="946 610 360 130" xmlns="http://www.w3.org/2000/svg">
            <path transform="matrix(0.992126,0,0,0.992126,946.227,721.063)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,1070.09,721.063)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,1268.27,721.063)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="977.099,717.888 977.099,640.453"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="1100.96,717.888 1100.96,640.453"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="1299.15,717.888 1299.15,640.453"/>
            <path fill-rule="evenodd" d="M975.735,634.252 L1300.51,634.252 L1300.51,646.654 L975.735,646.654 L975.735,634.252 "/>
            <path fill-rule="evenodd" d="M975.735,652.854 L1007.98,652.854 L1007.98,665.256 L975.735,665.256 L975.735,652.854 "/>
            <path fill-rule="evenodd" d="M1300.51,652.854 L1268.27,652.854 L1268.27,665.256 L1300.51,665.256 L1300.51,652.854 "/>
          </svg>
        </label>

        <!-- ti-ri-ti-ri - 4×16th kombineeritud (2+2) -->
        <label class="chk">
          <input type="checkbox" id="tok_tiritiri" />
          <svg width="80" height="30" viewBox="1003 610 100 130" xmlns="http://www.w3.org/2000/svg">
            <path transform="matrix(0.992126,0,0,0.992126,972.861,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,1014.52,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,1051.72,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="1003.73,693.085 1003.73,615.65"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="1045.4,693.085 1045.4,615.65"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="1082.59,693.085 1082.59,615.65"/>
            <path fill-rule="evenodd" d="M1002.37,609.449 L1083.96,609.449 L1083.96,621.85 L1002.37,621.85 L1002.37,609.449 "/>
            <path fill-rule="evenodd" d="M1044.03,628.051 L1083.96,628.051 L1083.96,640.453 L1044.03,640.453 L1044.03,628.051 "/>
          </svg>
        </label>
      </div>

      <!-- Vali kõik nupp -->
      <div style="margin-bottom: 12px;">
        <button type="button" id="btnSelectAll" class="secondary" style="width: 100%; font-size: 0.9rem;">✓ Vali kõik</button>
      </div>

      <label class="chk" style="margin-bottom: 12px;">
        <input type="checkbox" id="incl_rests" checked /> Lisa pausid (vastavad vältused)
      </label>

      <h2>Seaded</h2>
      <div class="row" style="margin-bottom: 10px;">
        <div style="flex:1; min-width: 140px;">
          <div class="muted" style="margin: 0 0 6px;">Taktimõõt</div>
          <select id="timeSig">
            <option value="2/4">2/4</option>
            <option value="3/4">3/4</option>
            <option value="4/4" selected>4/4</option>
          </select>
        </div>
        <div style="flex:1; min-width: 140px;">
          <div class="muted" style="margin: 0 0 6px;">Pikkus</div>
          <select id="length">
            <option value="2">2 takti</option>
            <option value="4" selected>4 takti</option>
            <option value="8">8 takti</option>
          </select>
        </div>
      </div>

      <div style="margin-bottom: 10px;">
        <div class="muted" style="margin: 0 0 6px;">Harjutuste arv</div>
        <select id="numExercises" style="width: 100%;">
          <option value="1" selected>1 harjutus</option>
          <option value="2">2 harjutust</option>
          <option value="3">3 harjutust</option>
          <option value="4">4 harjutust</option>
          <option value="5">5 harjutust</option>
          <option value="6">6 harjutust</option>
        </select>
      </div>

      <div class="btnbar">
        <button id="btnGen" type="button">Genereeri</button>
        <button id="btnAgain" type="button" class="secondary">Uuesti</button>
        <button id="btnPrint" type="button" class="ghost">Print</button>
      </div>

      <div class="small">Nipp: kui midagi ei uuene, tee värskendus (Ctrl+Shift+R / Cmd+Shift+R).</div>
    </section>

    <section class="card paper">
      <div id="paper"></div>
    </section>

  </div>

  <!-- Playback kontrollid - alati nähtavad fixed position -->
  <div id="playbackControls" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); margin-left: 80px; z-index: 200; background: var(--card); border: 1px solid var(--border); border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); padding: 12px 16px; display: flex; flex-direction: column; gap: 10px; max-width: 600px; width: calc(100% - 40px);">
    <div style="display: flex; align-items: center; gap: 12px;">
      <button id="btnPlay" type="button" style="background: linear-gradient(135deg, #10b981, #059669); font-size: 0.9rem; padding: 8px 16px; border: 0; border-radius: 10px; color: white; cursor: pointer; white-space: nowrap; transition: transform 0.12s;">▶ Mängi</button>
      <button id="btnStop" type="button" style="background: rgba(255,255,255,0.75); color: #111827; border: 1px solid var(--border); font-size: 0.9rem; padding: 8px 16px; border-radius: 10px; cursor: pointer; white-space: nowrap; transition: transform 0.12s;">⏹ Peata</button>
      <div style="flex: 1; display: flex; align-items: center; gap: 8px; min-width: 0;">
        <label for="tempoSlider" style="font-size: 0.85rem; white-space: nowrap;">Tempo:</label>
        <input type="range" id="tempoSlider" min="40" max="200" value="120" step="1" style="flex: 1; min-width: 80px;">
        <span style="font-weight: 600; color: var(--accent); font-size: 0.85rem; white-space: nowrap;"><span id="tempoValue">120</span> BPM</span>
      </div>
    </div>
    <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem; cursor: pointer; user-select: none;">
      <input type="checkbox" id="showPlaybackInFullscreen" checked style="cursor: pointer;">
      <span>Näita esitust täisvaates</span>
    </label>
  </div>

  <script>
    // === UNIT SYSTEM ===
    const TICKS_PER_BEAT = 24;

    // === RHYTHM LOGIC ===
    const DUR = {
      TA: 24,           // veerandnoot (1 beat)
      TA_A: 48,         // poolnoot (2 beats)
      TI_TI: 24,        // 2 kaheksandikku (1 beat)
      TI_RI: 24,        // 4 kuueteistkümnendiknoot (1 beat)
      TA_A_A: 96,       // täisnoot (4 beats)
      TA_A_I: 72,       // punkteeritud poolnoot (3 beats)
      DOTTED_8_16: 24,  // tai-ri: punkteeritud 8 + 16 (1 beat: 18 + 6)
      TRIPLET_8: 24,    // 3 kaheksandikku trioolis (1 beat: 8 + 8 + 8)
      SYNC_16_8_16: 24, // lühike sünkoop (1 beat: 6 + 12 + 6)
      SYNC_8_Q_8: 48,   // pikk sünkoop (2 beats: 12 + 24 + 12)
      TI_RI_TI: 24,     // 16+16+8 (1 beat: 6 + 6 + 12)
      TI_TI_RI: 24,     // 8+16+16 (1 beat: 12 + 6 + 6)
      TI_RI_TI_RI: 24   // 16+16+16+16 kombineeritud (1 beat: 6+6+6+6, kuid graafiliselt 2+2)
    };

    function beatsToTicks(numer, denom) {
      return numer * TICKS_PER_BEAT;
    }

    function getConfig() {
      const enabled = [];
      if (document.getElementById('tok_ta').checked) enabled.push('TA');
      if (document.getElementById('tok_taa').checked) enabled.push('TA_A');
      if (document.getElementById('tok_titi').checked) enabled.push('TI_TI');
      if (document.getElementById('tok_tiri').checked) enabled.push('TI_RI');
      if (document.getElementById('tok_taaa').checked) enabled.push('TA_A_A');
      if (document.getElementById('tok_taai').checked) enabled.push('TA_A_I');
      if (document.getElementById('tok_tairi').checked) enabled.push('DOTTED_8_16');
      if (document.getElementById('tok_triplet').checked) enabled.push('TRIPLET_8');
      if (document.getElementById('tok_sync').checked) {
        // Ainult PIKK sünkoop: 8+4+8
        enabled.push('SYNC_8_Q_8');
        enabled.push('SYNC_8_Q_8'); // kaks korda = suurem tõenäosus
      }
      if (document.getElementById('tok_tiriti').checked) {
        // Tiri-ti: 16+16+8
        enabled.push('TI_RI_TI');
      }
      if (document.getElementById('tok_titiri').checked) {
        // LÜHIKE sünkoop: 16+8+16
        enabled.push('SYNC_16_8_16');
      }
      if (document.getElementById('tok_tiritiri').checked) {
        // Ti-tiri: 8+16+16
        enabled.push('TI_TI_RI');
      }

      const includeRests = document.getElementById('incl_rests').checked;
      const ts = document.getElementById('timeSig').value;
      const parts = ts.split('/').map(x => parseInt(x, 10));
      const numer = parts[0];
      const denom = parts[1];
      const measures = parseInt(document.getElementById('length').value, 10);
      const numExercises = parseInt(document.getElementById('numExercises').value, 10);

      return { enabled, includeRests, numer, denom, measures, numExercises };
    }

    function pick(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function generateMeasure(cfg) {
      const total = beatsToTicks(cfg.numer, cfg.denom);
      let left = total;
      const out = [];

      const choices = [];
      for (const t of cfg.enabled) {
        choices.push({ kind: 'note', type: t, dur: DUR[t] });
        if (cfg.includeRests) {
          const restDur = (t === 'TA_A') ? DUR.TA_A : DUR.TA;
          choices.push({ kind: 'rest', type: 'REST', dur: restDur });
        }
      }

      if (choices.length === 0) {
        choices.push({ kind: 'note', type: 'TA', dur: DUR.TA });
      }

      for (let guard = 0; guard < 400 && left > 0; guard++) {
        const possible = choices.filter(c => c.dur <= left);
        if (possible.length === 0) break;

        let next = pick(possible);

        // Ei alusta takti pausiga
        if (out.length === 0 && next.kind === 'rest') {
          const nonRests = possible.filter(c => c.kind === 'note');
          if (nonRests.length) next = pick(nonRests);
        }

        // Ei pane pausid järjest
        const last = out[out.length - 1];
        if (last && last.kind === 'rest' && next.kind === 'rest') {
          const nonRests = possible.filter(c => c.kind === 'note');
          if (nonRests.length) next = pick(nonRests);
        }

        out.push(next);
        left -= next.dur;
      }

      // Täidame ülejäänud veeranditega
      while (left > 0) {
        if (left >= DUR.TA) {
          out.push({ kind: 'note', type: 'TA', dur: DUR.TA });
          left -= DUR.TA;
        } else {
          left = 0;
        }
      }

      return out;
    }

    function generateExercise(cfg) {
      const measures = [];
      for (let i = 0; i < cfg.measures; i++) measures.push(generateMeasure(cfg));
      return measures;
    }

    // === SVG RENDER ===
    function svgEl(tag, attrs) {
      const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
      if (attrs) {
        for (const k in attrs) el.setAttribute(k, String(attrs[k]));
      }
      return el;
    }

    function drawNotehead(svg, cx, cy, filled) {
      const e = svgEl('ellipse', {
        cx: cx,
        cy: cy,
        rx: 7.8,
        ry: 5.7,
        stroke: '#111',
        'stroke-width': 1.8,
        fill: filled ? '#111' : 'none'
      });
      e.setAttribute('transform', 'rotate(-20 ' + cx + ' ' + cy + ')');
      svg.appendChild(e);
    }

    function drawDot(svg, x, y) {
      svg.appendChild(svgEl('circle', { cx: x, cy: y, r: 2.3, fill: '#111' }));
    }

    function drawStemUp(svg, xRightOfHead, headY, stemH) {
      svg.appendChild(svgEl('rect', {
        x: xRightOfHead,
        y: headY - stemH,
        width: 2.2,
        height: stemH,
        fill: '#111'
      }));
    }

    function drawFlag(svg, xStem, yTop, isSixteenth) {
      const p1 = svgEl('path', {
        d: 'M ' + (xStem+2) + ' ' + (yTop+2) +
           ' C ' + (xStem+14) + ' ' + (yTop+6) + ', ' + (xStem+16) + ' ' + (yTop+18) + ', ' + (xStem+4) + ' ' + (yTop+22) +
           ' C ' + (xStem+12) + ' ' + (yTop+18) + ', ' + (xStem+10) + ' ' + (yTop+10) + ', ' + (xStem+2) + ' ' + (yTop+8) +
           ' Z',
        fill: '#111'
      });
      svg.appendChild(p1);

      if (isSixteenth) {
        const y2 = yTop + 10;
        const p2 = svgEl('path', {
          d: 'M ' + (xStem+2) + ' ' + (y2+2) +
             ' C ' + (xStem+14) + ' ' + (y2+6) + ', ' + (xStem+16) + ' ' + (y2+18) + ', ' + (xStem+4) + ' ' + (y2+22) +
             ' C ' + (xStem+12) + ' ' + (y2+18) + ', ' + (xStem+10) + ' ' + (y2+10) + ', ' + (xStem+2) + ' ' + (y2+8) +
             ' Z',
          fill: '#111'
        });
        svg.appendChild(p2);
      }
    }

    const GLYPH_REST_QUARTER = String.fromCodePoint(0x1D13D);
    const GLYPH_REST_EIGHTH = String.fromCodePoint(0x1D13E);
    const GLYPH_REST_SIXTEENTH = String.fromCodePoint(0x1D13F);

    function drawRest(svg, cx, cy, durTicks) {
      const xOpt = cx + 6;

      if (durTicks >= 48) {
        const w = 22;
        const h = 8;
        const y = cy - 18;
        svg.appendChild(svgEl('rect', { x: xOpt - w/2, y: y, width: w, height: h, fill: '#111', rx: 2 }));
        svg.appendChild(svgEl('line', {
          x1: xOpt - (w/2) - 6,
          y1: y,
          x2: xOpt + (w/2) + 6,
          y2: y,
          stroke: '#111',
          'stroke-width': 2
        }));
        return;
      }

      let glyph = GLYPH_REST_QUARTER;
      if (durTicks === 12) glyph = GLYPH_REST_EIGHTH;
      if (durTicks === 6) glyph = GLYPH_REST_SIXTEENTH;

      const t = svgEl('text', {
        x: xOpt,
        y: cy - 10,
        'text-anchor': 'middle',
        'dominant-baseline': 'middle',
        'font-size': 40,
        'font-family': 'Bravura, "Noto Music", "Segoe UI Symbol", "Arial Unicode MS", serif',
        fill: '#111'
      });
      t.textContent = glyph;
      svg.appendChild(t);
    }

    function beatGrid(cfg, x0, x1, isLastMeasure) {
      const padL = 4;
      const padR = isLastMeasure ? 18 : 12;
      const innerX0 = x0 + padL;
      const innerX1 = x1 - padR;
      const beats = cfg.numer;
      const beatW = (innerX1 - innerX0) / beats;
      return { innerX0, innerX1, beatW, beats };
    }

    function centersFromParts(spanX0, spanW, partsTicks, pad) {
      const total = partsTicks.reduce((a,b)=>a+b,0);
      const usable = Math.max(0, spanW - pad*2);
      let cur = 0;
      return partsTicks.map(d => {
        const c = spanX0 + pad + (cur + d/2) * (usable / total);
        cur += d;
        return c;
      });
    }

    function drawTripletBracket(svg, xA, xB, y, label) {
      const h = 8;
      svg.appendChild(svgEl('line', { x1: xA, y1: y, x2: xB, y2: y, stroke: '#111', 'stroke-width': 1.6 }));
      svg.appendChild(svgEl('line', { x1: xA, y1: y, x2: xA, y2: y + h, stroke: '#111', 'stroke-width': 1.6 }));
      svg.appendChild(svgEl('line', { x1: xB, y1: y, x2: xB, y2: y + h, stroke: '#111', 'stroke-width': 1.6 }));
      const t = svgEl('text', { x: (xA+xB)/2, y: y - 2, 'text-anchor': 'middle', 'font-size': 22, 'font-family': 'serif', fill: '#111' });
      t.textContent = label || '3';
      svg.appendChild(t);
    }

    function renderMultipleExercises(cfg) {
      const paper = document.getElementById('paper');
      paper.innerHTML = '';
      
      const numEx = cfg.numExercises || 1;
      
      for (let exNum = 1; exNum <= numEx; exNum++) {
        const titleDiv = document.createElement('div');
        titleDiv.style.fontSize = '1.2rem';
        titleDiv.style.fontWeight = 'bold';
        titleDiv.style.marginTop = exNum > 1 ? '40px' : '10px';
        titleDiv.style.marginBottom = '10px';
        titleDiv.textContent = numEx > 1 ? `Harjutus ${exNum}` : '';
        paper.appendChild(titleDiv);
        
        const measures = generateExercise(cfg);
        
        // Salvesta esimene harjutus playback jaoks
        if (exNum === 1) {
          currentExerciseData = measures;
          currentExerciseConfig = cfg;
        }
        
        renderSingleExercise(cfg, measures, paper);
      }
    }

    function renderSingleExercise(cfg, measures, container) {
      const marginLeft = 58;
      const marginTop = 24;
      const rowMeasures = 4;
      const measureW = 320;
      const gap = 16;
      const rowGapY = 110;
      const rightPad = 28;

      const rows = Math.ceil(measures.length / rowMeasures);
      const cols = Math.min(rowMeasures, measures.length);

      const W = marginLeft + cols * (measureW + gap) - gap + rightPad;
      const H = 170 + (rows - 1) * 130;

      const svg = svgEl('svg', { width: W, height: H, viewBox: '0 0 ' + W + ' ' + H });
      container.appendChild(svg);

      const topY = 38;
      const bottomY = 116;
      const noteY = 80;
      const stemH = 38;

      function drawTimeSigAtRow(yRow0) {
        const tsX = 18;
        const tsTop = svgEl('text', { x: tsX, y: yRow0 + 78, 'font-size': 30, 'font-family': 'serif', fill: '#111' });
        tsTop.textContent = String(cfg.numer);
        const tsBottom = svgEl('text', { x: tsX, y: yRow0 + 106, 'font-size': 30, 'font-family': 'serif', fill: '#111' });
        tsBottom.textContent = String(cfg.denom);
        svg.appendChild(tsTop);
        svg.appendChild(tsBottom);
      }

      function drawBarline(x, y0) {
        svg.appendChild(svgEl('line', { x1: x, y1: y0 + topY, x2: x, y2: y0 + bottomY, stroke: '#111', 'stroke-width': 2 }));
      }

      function drawFinalBarline(x, y0) {
        svg.appendChild(svgEl('line', { x1: x, y1: y0 + topY, x2: x, y2: y0 + bottomY, stroke: '#111', 'stroke-width': 2 }));
        svg.appendChild(svgEl('line', { x1: x + 6, y1: y0 + topY, x2: x + 6, y2: y0 + bottomY, stroke: '#111', 'stroke-width': 5 }));
      }

      const totalTicks = beatsToTicks(cfg.numer, cfg.denom);
      const TPB = TICKS_PER_BEAT;

      const PAD_TITI = 6;
      const PAD_TIRI = 8;   // 16th noodid - suurem vahe paremaks loetavuseks
      const PAD_TRIP = 2;
      const PAD_DOTTED = 5;
      const PAD_SYNC = 5;   // sünkoobid - veidi suurem vahe

      for (let i = 0; i < measures.length; i++) {
        const row = Math.floor(i / rowMeasures);
        const col = i % rowMeasures;

        const y0 = marginTop + row * rowGapY;
        const x0 = marginLeft + col * (measureW + gap);
        const x1 = x0 + measureW;

        if (col === 0) drawTimeSigAtRow(y0);

        const isLast = (i === measures.length - 1);
        if (isLast) drawFinalBarline(x1, y0);
        else drawBarline(x1, y0);

        const grid = beatGrid(cfg, x0, x1, isLast);
        const tokens = measures[i];

        let cursor = 0;
        for (const tok of tokens) {
          const startBeat = cursor / TPB;
          const spanBeats = tok.dur / TPB;

          const spanX0 = grid.innerX0 + startBeat * grid.beatW;
          const spanW = spanBeats * grid.beatW;

          let parts;
          if (tok.kind === 'rest') {
            parts = [{ kind: 'rest', ticks: tok.dur, optional: true }];
          } else if (tok.type === 'TA') {
            parts = [{ kind: 'note', ticks: DUR.TA }];
          } else if (tok.type === 'TA_A') {
            parts = [{ kind: 'note', ticks: DUR.TA_A }];
          } else if (tok.type === 'TA_A_A') {
            parts = [{ kind: 'note', ticks: DUR.TA_A_A }];
          } else if (tok.type === 'TA_A_I') {
            parts = [{ kind: 'note', ticks: DUR.TA_A_I, dotted: true }];
          } else if (tok.type === 'TI_TI') {
            parts = [
              { kind: 'note', ticks: 12, level: 1 },
              { kind: 'note', ticks: 12, level: 1 }
            ];
          } else if (tok.type === 'TI_RI') {
            parts = [
              { kind: 'note', ticks: 6, level: 2 },
              { kind: 'note', ticks: 6, level: 2 },
              { kind: 'note', ticks: 6, level: 2 },
              { kind: 'note', ticks: 6, level: 2 }
            ];
          } else if (tok.type === 'DOTTED_8_16') {
            parts = [
              { kind: 'note', ticks: 18, dotted: true, level: 1 },
              { kind: 'note', ticks: 6, level: 2 }
            ];
          } else if (tok.type === 'TRIPLET_8') {
            parts = [
              { kind: 'note', ticks: 8, level: 1 },
              { kind: 'note', ticks: 8, level: 1 },
              { kind: 'note', ticks: 8, level: 1 }
            ];
          } else if (tok.type === 'SYNC_16_8_16') {
            parts = [
              { kind: 'note', ticks: 6, level: 2 },
              { kind: 'note', ticks: 12, level: 1 },
              { kind: 'note', ticks: 6, level: 2 }
            ];
          } else if (tok.type === 'SYNC_8_Q_8') {
            parts = [
              { kind: 'note', ticks: 12, level: 1, forceFlag: true },
              { kind: 'note', ticks: 24, level: 0 },
              { kind: 'note', ticks: 12, level: 1, forceFlag: true }
            ];
          } else if (tok.type === 'TI_RI_TI') {
            parts = [
              { kind: 'note', ticks: 6, level: 2 },
              { kind: 'note', ticks: 6, level: 2 },
              { kind: 'note', ticks: 12, level: 1 }
            ];
          } else if (tok.type === 'TI_TI_RI') {
            parts = [
              { kind: 'note', ticks: 12, level: 1 },
              { kind: 'note', ticks: 6, level: 2 },
              { kind: 'note', ticks: 6, level: 2 }
            ];
          } else if (tok.type === 'TI_RI_TI_RI') {
            parts = [
              { kind: 'note', ticks: 6, level: 2 },
              { kind: 'note', ticks: 6, level: 2 },
              { kind: 'note', ticks: 6, level: 2 },
              { kind: 'note', ticks: 6, level: 2 }
            ];
          } else {
            parts = [{ kind: 'note', ticks: tok.dur }];
          }

          const pad = (
            tok.type === 'TI_TI' ? PAD_TITI :
            tok.type === 'TI_RI' ? PAD_TIRI :
            tok.type === 'TRIPLET_8' ? PAD_TRIP :
            tok.type === 'DOTTED_8_16' ? PAD_DOTTED :
            tok.type === 'SYNC_16_8_16' ? PAD_SYNC :
            tok.type === 'SYNC_8_Q_8' ? PAD_SYNC :
            6
          );

          const centers = (parts.length === 1)
            ? [spanX0 + spanW/2]
            : centersFromParts(spanX0, spanW, parts.map(p => p.ticks), pad);

          const stemXs = [];
          const stemTopY = y0 + noteY - stemH;

          for (let pi = 0; pi < parts.length; pi++) {
            const p = parts[pi];
            const cx = centers[pi];

            if (p.kind === 'rest') {
              if (!p.optional || p.required || cfg.includeRests) {
                drawRest(svg, cx, y0 + noteY, p.ticks);
              }
              continue;
            }

            const isHalf = (p.ticks >= 48) || (tok.type === 'TA_A_A') || (tok.type === 'TA_A_I');
            const filled = !isHalf;
            drawNotehead(svg, cx, y0 + noteY, filled);
            
            // Täisnoot ei vaja varsi
            if (tok.type !== 'TA_A_A') {
              drawStemUp(svg, cx + 6, y0 + noteY, stemH);
              stemXs.push(cx + 6);
            }

            if (p.dotted) drawDot(svg, cx + 14, y0 + noteY - 2);

            if (p.forceFlag) {
              drawFlag(svg, cx + 6, stemTopY, false);
            }
          }

          const beamY = stemTopY;
          function beamLine(xA, xB, y, thickness) {
            svg.appendChild(svgEl('rect', { x: xA, y: y, width: (xB - xA), height: (thickness || 6), fill: '#111' }));
          }

          if (tok.type === 'TI_TI' && stemXs.length === 2) {
            beamLine(stemXs[0], stemXs[1] + 2, beamY, 6);
          }

          if (tok.type === 'TI_RI' && stemXs.length === 4) {
            beamLine(stemXs[0], stemXs[3] + 2, beamY, 6);
            beamLine(stemXs[0], stemXs[3] + 2, beamY + 9, 6);
          }

          if (tok.type === 'TRIPLET_8' && stemXs.length === 3) {
            beamLine(stemXs[0], stemXs[2] + 2, beamY, 6);
            const xA = centers[0] - 10;
            const xB = centers[2] + 10;
            drawTripletBracket(svg, xA, xB, beamY - 18, '3');
          }

          if (tok.type === 'DOTTED_8_16' && stemXs.length === 2) {
            beamLine(stemXs[0], stemXs[1] + 2, beamY, 6);
            beamLine(stemXs[1] - 10, stemXs[1] + 2, beamY + 9, 6);
          }

          if (tok.type === 'SYNC_16_8_16' && stemXs.length === 3) {
            beamLine(stemXs[0], stemXs[2] + 2, beamY, 6);
            beamLine(stemXs[0] + 1, stemXs[0] + 7, beamY + 9, 6);
            beamLine(stemXs[2] - 6, stemXs[2] + 2, beamY + 9, 6);
          }

          if (tok.type === 'TI_RI_TI' && stemXs.length === 3) {
            beamLine(stemXs[0], stemXs[2] + 2, beamY, 6);
            beamLine(stemXs[0], stemXs[1] + 2, beamY + 9, 6);
          }

          if (tok.type === 'TI_TI_RI' && stemXs.length === 3) {
            beamLine(stemXs[0], stemXs[2] + 2, beamY, 6);
            beamLine(stemXs[1], stemXs[2] + 2, beamY + 9, 6);
          }

          if (tok.type === 'TI_RI_TI_RI' && stemXs.length === 4) {
            beamLine(stemXs[0], stemXs[3] + 2, beamY, 6);      // ülemine beam
            beamLine(stemXs[0], stemXs[3] + 2, beamY + 9, 6);  // alumine beam (16th)
          }

          cursor += tok.dur;
        }

        if (cursor !== totalTicks) {
          console.error('Takti ticks ei klapi', { i: i, cursor: cursor, totalTicks: totalTicks });
        }
      }
    }

    function formatErrorText(err) {
      const msg = (err && err.message) ? err.message : String(err);
      const stack = (err && err.stack) ? err.stack : '';
      return 'Viga: ' + msg + '\n\n' + stack;
    }

    function showError(err) {
      const paper = document.getElementById('paper');
      paper.innerHTML = '';
      const pre = document.createElement('pre');
      pre.style.whiteSpace = 'pre-wrap';
      pre.style.padding = '12px';
      pre.style.color = '#111';
      pre.textContent = formatErrorText(err);
      paper.appendChild(pre);
    }

    let lastCfg = null;

    function generateAndRender() {
      try {
        stopPlayback();
        const cfg = getConfig();
        lastCfg = cfg;
        renderMultipleExercises(cfg);
      } catch (err) {
        console.error(err);
        showError(err);
      }
    }

    function again() {
      try {
        stopPlayback();
        if (!lastCfg) return generateAndRender();
        renderMultipleExercises(lastCfg);
      } catch (err) {
        console.error(err);
        showError(err);
      }
    }

    function printPage() {
      window.print();
    }

    document.getElementById('btnGen').addEventListener('click', (e) => { e.preventDefault(); generateAndRender(); });
    document.getElementById('btnAgain').addEventListener('click', (e) => { e.preventDefault(); again(); });
    document.getElementById('btnPrint').addEventListener('click', (e) => { e.preventDefault(); printPage(); });
    
    // Vali kõik nupp
    document.getElementById('btnSelectAll').addEventListener('click', (e) => {
      e.preventDefault();
      const allChecked = document.querySelectorAll('.grid input[type="checkbox"]');
      const anyUnchecked = Array.from(allChecked).some(cb => !cb.checked);
      
      allChecked.forEach(cb => {
        cb.checked = anyUnchecked;
      });
      
      // Muuda nupu teksti
      e.target.textContent = anyUnchecked ? '✗ Tühista valik' : '✓ Vali kõik';
    });
    
    // Kontrollide peitmise ja täisekraani toggle
    const btnToggle = document.getElementById('btnToggleUI');
    const layout = document.querySelector('.layout');
    let controlsHidden = false;
    
    btnToggle.addEventListener('click', async (e) => {
      e.preventDefault();
      controlsHidden = !controlsHidden;
      
      if (controlsHidden) {
        layout.classList.add('controls-hidden');
        document.body.classList.add('controls-hidden');
        btnToggle.textContent = '⚙️ Näita kontrolle';
        btnToggle.classList.remove('ghost');
        btnToggle.classList.add('primary');
        
        // Proovi minna täisekraani
        try {
          if (document.documentElement.requestFullscreen) {
            await document.documentElement.requestFullscreen();
          }
        } catch (err) {
          console.log('Täisekraan ei õnnestunud:', err);
        }
      } else {
        layout.classList.remove('controls-hidden');
        document.body.classList.remove('controls-hidden');
        btnToggle.textContent = '⚙️ Peida kontrollid';
        btnToggle.classList.remove('primary');
        btnToggle.classList.add('ghost');
        
        // Välju täisekraanist
        try {
          if (document.fullscreenElement && document.exitFullscreen) {
            await document.exitFullscreen();
          }
        } catch (err) {
          console.log('Täisekraanist väljumine ei õnnestunud:', err);
        }
      }
    });
    
    // ========== AUDIO PLAYBACK ==========
    let audioContext = null;
    let currentExerciseData = null;
    let isPlaying = false;
    let scheduledNotes = [];
    let currentNoteIndex = 0;

    function initAudioContext() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
    }

    function playClick(time, accent = false) {
      initAudioContext();
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      
      osc.connect(gain);
      gain.connect(audioContext.destination);
      
      osc.frequency.value = accent ? 1200 : 800;
      gain.gain.setValueAtTime(accent ? 0.3 : 0.2, time);
      gain.gain.exponentialRampToValueAtTime(0.01, time + 0.05);
      
      osc.start(time);
      osc.stop(time + 0.05);
    }

    function schedulePlayback() {
      if (!currentExerciseData || !isPlaying) return;

      const currentTime = audioContext.currentTime;
      const scheduleAhead = 0.2; // Suurem buffer stabiilsuse jaoks

      // Ajakava järgmised noodid
      while (currentNoteIndex < scheduledNotes.length &&
             scheduledNotes[currentNoteIndex].time < currentTime + scheduleAhead) {
        const note = scheduledNotes[currentNoteIndex];
        playClick(note.time, note.accent);
        currentNoteIndex++;
      }

      // Kui on veel noote, jätka
      if (currentNoteIndex < scheduledNotes.length && isPlaying) {
        requestAnimationFrame(schedulePlayback);
      } else {
        stopPlayback();
      }
    }

    function startPlayback() {
      if (!currentExerciseData || currentExerciseData.length === 0) {
        alert('Genereeri esmalt harjutus!');
        return;
      }

      initAudioContext();
      
      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }

      const tempo = parseInt(document.getElementById('tempoSlider').value);
      const beatDuration = 60 / tempo;
      const ticksPerBeat = TICKS_PER_BEAT;

      // Loo metroonomi jadastus - tikk iga LÖÖK kohta
      scheduledNotes = [];
      let time = audioContext.currentTime + 0.1; // Väike delay

      currentExerciseData.forEach((measure) => {
        const beatsPerBar = currentExerciseConfig.numer;
        let currentBeat = 0;
        
        // Lisa tikk iga löök (veerandnoot) kohta
        for (let beat = 0; beat < beatsPerBar; beat++) {
          const accent = (beat === 0); // Aktsent esimesel löögil
          scheduledNotes.push({ time: time + (beat * beatDuration), accent });
        }
        
        // Arvuta takti kogupikkus
        const measureDuration = measure.reduce((sum, token) => sum + token.dur, 0);
        time += (measureDuration / ticksPerBeat) * beatDuration;
      });

      currentNoteIndex = 0;
      isPlaying = true;
      document.getElementById('btnPlay').disabled = true;
      document.getElementById('btnStop').disabled = false;

      schedulePlayback();
    }

    function stopPlayback() {
      isPlaying = false;
      currentNoteIndex = 0;
      scheduledNotes = [];
      document.getElementById('btnPlay').disabled = false;
      document.getElementById('btnStop').disabled = true;
    }

    document.getElementById('btnPlay').addEventListener('click', startPlayback);
    document.getElementById('btnStop').addEventListener('click', stopPlayback);
    
    document.getElementById('tempoSlider').addEventListener('input', (e) => {
      document.getElementById('tempoValue').textContent = e.target.value;
    });

    // Esituse nähtavuse kontroll täisekraanis
    document.getElementById('showPlaybackInFullscreen').addEventListener('change', (e) => {
      const playbackControls = document.getElementById('playbackControls');
      if (e.target.checked) {
        playbackControls.classList.remove('hidden-in-fullscreen');
      } else {
        playbackControls.classList.add('hidden-in-fullscreen');
      }
    });

    let currentExerciseConfig = null;
    
    // Kui kasutaja vajutab ESC täisekraanist väljumiseks, taasta ka kontrollid
    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement && controlsHidden) {
        controlsHidden = false;
        layout.classList.remove('controls-hidden');
        document.body.classList.remove('controls-hidden');
        btnToggle.textContent = '⚙️ Peida kontrollid';
        btnToggle.classList.remove('primary');
        btnToggle.classList.add('ghost');
      }
    });

    window.addEventListener('error', (e) => {
      try { showError(e && e.error ? e.error : e); } catch (_) {}
    });

    generateAndRender();
  </script>

</body>
</html>
