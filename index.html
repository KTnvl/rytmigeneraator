<!DOCTYPE html>
<html lang="et">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Rütmiharjutuste generaator (beeta)</title>

  <style>
    :root {
      --bg: #f6f8ff;
      --card: #ffffff;
      --ink: #1f2937;
      --muted: #6b7280;
      --accent: #3b82f6;
      --border: #e5e7eb;
    }

    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      color: var(--ink);
      background: radial-gradient(1200px 500px at 10% 0%, #eef2ff 0%, var(--bg) 55%, #fff7ed 120%);
      max-width: 1200px;
      margin: 22px auto;
      padding: 0 14px 40px;
      line-height: 1.35;
    }

    header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    h1 {
      margin: 8px 0 6px;
      font-size: 1.85rem;
      letter-spacing: -0.02em;
    }

    .tagline {
      display: inline-block;
      margin-top: 6px;
      padding: 8px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.7);
      border: 1px solid var(--border);
      color: #4b5563;
    }

    .layout {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 14px;
    }

    @media (min-width: 920px) {
      .layout {
        grid-template-columns: 360px minmax(0, 1fr);
        align-items: start;
      }
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 14px 30px rgba(17, 24, 39, 0.08);
      padding: 14px;
      min-width: 0;
    }

    .card.paper {
      padding: 10px;
      overflow: hidden; /* hoiab ära “UI peale ujuva” tunde */
    }

    .controls h2 {
      margin: 0 0 10px;
      font-size: 1.05rem;
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* Rhythm pickers (ainult ikoonid) */
    .rhythm-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    @media (min-width: 460px) {
      .rhythm-grid { grid-template-columns: 1fr 1fr; }
    }

    @media (min-width: 920px) {
      .rhythm-grid { grid-template-columns: 1fr 1fr; }
    }

    label.chk {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px 10px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,0.75);
      cursor: pointer;
      transition: background 120ms ease;
      min-height: 64px;
    }

    label.chk:hover { background: rgba(255,255,255,0.95); }

    label.chk input {
      transform: scale(1.2);
      flex-shrink: 0;
    }

    label.chk svg {
      flex-shrink: 0;
      display: block;
    }

    .muted { color: var(--muted); }

    select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.85);
      font-size: 1rem;
    }

    .btnbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    button {
      font-size: 1.05rem;
      padding: 12px 16px;
      cursor: pointer;
      border: 0;
      border-radius: 16px;
      color: white;
      background: linear-gradient(135deg, var(--accent), #22c55e);
      box-shadow: 0 10px 22px rgba(59, 130, 246, 0.18);
      transition: transform 120ms ease, box-shadow 120ms ease;
    }

    button:hover { transform: translateY(-1px); box-shadow: 0 14px 28px rgba(59, 130, 246, 0.22); }
    button:active { transform: translateY(0px); box-shadow: 0 10px 22px rgba(59, 130, 246, 0.16); }

    button.secondary {
      background: #111827;
      box-shadow: 0 10px 22px rgba(17, 24, 39, 0.12);
    }

    button.ghost {
      background: rgba(255,255,255,0.75);
      color: #111827;
      border: 1px solid var(--border);
      box-shadow: none;
    }

    /* Harjutuse ala: väike ja viisakas */
    #paper {
      overflow: auto;
      max-height: min(72vh, 760px);
      padding: 6px;
    }

    #paper svg {
      display: block;
      width: 100%;
      height: auto;
    }

    .small {
      margin-top: 16px;
      font-size: 0.98rem;
      color: var(--muted);
    }

    /* PRINT */
    @media print {
      @page { margin: 12mm; }
      body { background: white; margin: 0; max-width: none; padding: 0; }
      header, .controls { display: none !important; }
      .card { box-shadow: none; border: 0; padding: 0; }
      .layout { grid-template-columns: 1fr; }
      #paper { overflow: visible; max-height: none; padding: 0; }
      #paper svg { width: 100% !important; height: auto !important; }
      #paper > div:not(:first-child) { page-break-before: avoid; margin-top: 30px; }
    }
  </style>
</head>
<body>

  <!-- MuseScore SVG master (kasutame sellest väikseid “croppe” ikoonideks) -->
  <svg width="0" height="0" style="position:absolute; left:-9999px; top:-9999px;" aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg">
    <symbol id="ms_all" viewBox="0 0 2976.38 4209.45">
<desc>Generated by MuseScore 4.0.2</desc>
<defs>
<style type="text/css"><![CDATA[
    .StaffLines { stroke-width: 0.9303; }
    .BarLine { stroke-width: 1.5505; }
    .Stem { stroke-width: 0.9303; }
    .Note { stroke-linejoin: round; stroke-linecap: round; }
    .Text { font-family: 'Edwin'; font-size: 10px; }
]]></style>
</defs>
<g class="Page">
<g class="System">
<g class="Staff">
<path class="StaffLines" fill="none" stroke="#000000" stroke-width="0.930303" stroke-linecap="round" stroke-linejoin="round" d="M389.734,625.512 L2789.63,625.512"/>
<path class="StaffLines" fill="none" stroke="#000000" stroke-width="0.930303" stroke-linecap="round" stroke-linejoin="round" d="M389.734,647.84 L2789.63,647.84"/>
<path class="StaffLines" fill="none" stroke="#000000" stroke-width="0.930303" stroke-linecap="round" stroke-linejoin="round" d="M389.734,670.168 L2789.63,670.168"/>
<path class="StaffLines" fill="none" stroke="#000000" stroke-width="0.930303" stroke-linecap="round" stroke-linejoin="round" d="M389.734,692.496 L2789.63,692.496"/>
<path class="StaffLines" fill="none" stroke="#000000" stroke-width="0.930303" stroke-linecap="round" stroke-linejoin="round" d="M389.734,714.824 L2789.63,714.824"/>
</g>
<g class="Measure" id="Measure-1">
<g class="BarLine">
<path class="BarLine" stroke="#000000" stroke-width="1.5505" stroke-linecap="round" stroke-linejoin="round" fill="none" d="M389.734,625.512 L389.734,714.824"/>
</g>
<g class="Chord">
<path class="Note" fill-rule="evenodd" fill="#000000" d="M432.374,684.42 C440.208,679.687 446.326,679.687 453.592,684.42 C457.758,687.144 460.053,689.439 462.634,693.75 C465.215,698.061 465.215,702.228 462.634,706.681 C459.767,711.562 455.314,714.824 449.579,716.115 C444.698,717.406 439.961,717.119 435.507,714.967 C432.374,713.533 430.08,711.957 428.358,709.949 C426.923,707.942 425.632,705.791 424.628,703.353 C423.623,700.629 423.049,698.061 423.049,695.767 C423.049,690.029 426.062,686.145 432.374,684.42 M437.255,693.75 C438.833,699.343 440.554,703.21 442.705,705.935 C445.142,708.802 448.009,710.092 451.414,709.949 C453.879,709.82 455.681,708.673 456.796,706.522 C458.087,704.084 458.518,700.773 457.758,696.749 C456.653,691.012 454.932,686.847 452.494,684.266 C450.2,681.829 447.476,680.667 444.2,680.81 C439.032,681.054 436.021,685.22 435.507,693.75"/>
</g>
<g class="Chord">
<path class="Note" fill-rule="evenodd" fill="#000000" d="M577.103,677.154 C582.126,674.143 585.973,674.143 590.714,677.154 C593.433,678.876 595.011,680.454 596.59,683.319 C598.297,686.186 598.44,688.91 596.59,691.919 C594.867,695.196 592.004,697.49 588.156,698.366 C585.12,699.243 582.126,699.098 579.262,697.664 C577.103,696.831 575.812,695.683 574.679,694.25 C573.674,692.815 572.941,691.525 572.207,689.949 C571.474,687.957 571.187,686.234 571.187,684.512 C571.187,680.38 573.194,677.677 577.103,677.154 M581.27,683.896 C582.418,687.886 583.567,690.609 585.275,692.475 C586.996,694.625 589.004,695.63 591.299,695.483 C592.994,695.399 594.199,694.541 595.011,692.815 C595.872,690.98 596.016,688.541 595.441,685.532 C594.723,681.386 593.574,678.533 591.852,676.668 C590.143,674.817 588.136,673.954 585.701,674.099 C581.844,674.143 579.692,677.298 579.692,683.896"/>
<path class="Stem" fill="none" stroke="#000000" stroke-width="0.930303" stroke-linecap="round" stroke-linejoin="round" d="M595.298,695.197 L595.298,623.36"/>
</g>
<g class="Chord">
<path class="Note" fill-rule="evenodd" fill="#000000" d="M721.685,668.684 C725.709,666.39 728.719,666.39 732.428,668.684 C734.579,670.167 735.887,671.455 737.178,673.749 C738.612,675.885 738.756,678.179 737.178,680.474 C735.744,682.911 733.45,684.633 730.441,685.22 C727.574,685.936 724.993,685.654 722.556,684.362 C720.833,683.63 719.685,682.625 718.808,681.32 C717.932,680.186 717.34,679.038 716.897,677.725 C716.307,675.885 716.02,674.45 716.02,673.017 C716.02,669.74 717.454,667.446 721.685,668.684 M726.423,674.019 C727.141,677.011 728.145,679.036 729.437,680.611 C730.871,682.049 732.449,682.911 734.312,682.764 C735.502,682.719 736.379,682.137 736.973,681.132 C737.69,679.838 737.834,677.869 737.26,675.574 C736.686,672.438 735.825,670.152 734.391,668.858 C733.1,667.426 731.52,666.838 729.529,666.984 C726.707,667.13 725.133,669.441 725.133,674.163"/>
<path class="Stem" fill="none" stroke="#000000" stroke-width="0.930303" stroke-linecap="round" stroke-linejoin="round" d="M737.547,682.766 L737.547,611.216"/>
</g>
<g class="Chord">
<path class="Note" fill-rule="evenodd" fill="#000000" d="M866.267,670.419 C870.291,668.125 873.301,668.125 877.01,670.419 C879.161,671.902 880.469,673.19 881.76,675.484 C883.194,677.62 883.338,679.914 881.76,682.209 C880.326,684.646 878.032,686.368 875.023,686.955 C872.156,687.671 869.575,687.389 867.138,686.097 C865.415,685.365 864.267,684.36 863.39,683.055 C862.514,681.921 861.922,680.773 861.479,679.46 C860.889,677.62 860.602,676.185 860.602,674.752 C860.602,671.475 862.036,669.181 866.267,670.419 M871.005,675.754 C871.723,678.746 872.727,680.771 874.019,682.346 C875.453,683.784 877.031,684.646 878.894,684.499 C880.084,684.454 880.961,683.872 881.555,682.867 C882.272,681.573 882.416,679.604 881.842,677.309 C881.268,674.173 880.407,671.887 878.973,670.593 C877.682,669.161 876.102,668.573 874.111,668.719 C871.289,668.865 869.715,671.176 869.715,675.898"/>
<path class="Stem" fill="none" stroke="#000000" stroke-width="0.930303" stroke-linecap="round" stroke-linejoin="round" d="M882.129,684.501 L882.129,612.951"/>
<path class="Beam" fill-rule="evenodd" fill="#000000" d="M737.178,611.216 L882.129,612.951 L882.129,621.974 L737.178,620.239"/>
</g>
<g class="Chord">
<path class="Note" fill-rule="evenodd" fill="#000000" d="M1010.85,675.054 C1014.88,672.76 1017.89,672.76 1021.6,675.054 C1023.75,676.537 1025.05,677.825 1026.35,680.119 C1027.78,682.255 1027.92,684.549 1026.35,686.844 C1024.91,689.281 1022.62,691.003 1019.61,691.59 C1016.74,692.306 1014.16,692.024 1011.72,690.732 C1010,690 1008.85,688.995 1007.97,687.69 C1007.09,686.556 1006.5,685.408 1006.06,684.095 C1005.47,682.255 1005.18,680.82 1005.18,679.387 C1005.18,676.11 1006.62,673.816 1010.85,675.054 M1015.59,680.389 C1016.3,683.381 1017.31,685.406 1018.6,686.981 C1020.04,688.419 1021.62,689.281 1023.48,689.134 C1024.67,689.089 1025.54,688.507 1026.14,687.502 C1026.86,686.208 1027,684.239 1026.42,681.944 C1025.85,678.808 1024.99,676.522 1023.55,675.228 C1022.27,673.796 1020.69,673.208 1018.7,673.354 C1015.87,673.5 1014.3,675.811 1014.3,680.533"/>
<path class="Stem" fill="none" stroke="#000000" stroke-width="0.930303" stroke-linecap="round" stroke-linejoin="round" d="M1026.71,689.136 L1026.71,617.586"/>
<path class="Beam" fill-rule="evenodd" fill="#000000" d="M882.129,612.951 L1026.71,617.586 L1026.71,626.609 L882.129,621.974"/>
</g>
<g class="Chord">
<path class="Note" fill-rule="evenodd" fill="#000000" d="M1155.43,679.689 C1159.46,677.395 1162.47,677.395 1166.18,679.689 C1168.33,681.172 1169.63,682.46 1170.93,684.754 C1172.36,686.89 1172.5,689.184 1170.93,691.479 C1169.49,693.916 1167.2,695.638 1164.19,696.225 C1161.32,696.941 1158.74,696.659 1156.3,695.367 C1154.58,694.635 1153.43,693.63 1152.55,692.325 C1151.67,691.191 1151.08,690.043 1150.64,688.73 C1150.05,686.89 1149.76,685.455 1149.76,684.022 C1149.76,680.745 1151.2,678.451 1155.43,679.689 M1160.17,685.024 C1160.88,688.016 1161.89,690.041 1163.18,691.616 C1164.62,693.054 1166.2,693.916 1168.06,693.769 C1169.25,693.724 1170.12,693.142 1170.72,692.137 C1171.44,690.843 1171.58,688.874 1171,686.579 C1170.43,683.443 1169.57,681.157 1168.13,679.863 C1166.85,678.431 1165.27,677.843 1163.28,677.989 C1160.45,678.135 1158.88,680.446 1158.88,685.168"/>
<path class="Stem" fill="none" stroke="#000000" stroke-width="0.930303" stroke-linecap="round" stroke-linejoin="round" d="M1171.29,693.771 L1171.29,622.221"/>
<path class="Beam" fill-rule="evenodd" fill="#000000" d="M1026.71,617.586 L1171.29,622.221 L1171.29,631.244 L1026.71,626.609"/>
</g>
<g class="Chord">
<path class="Note" fill-rule="evenodd" fill="#000000" d="M1300.02,684.324 C1304.04,682.03 1307.05,682.03 1310.76,684.324 C1312.91,685.807 1314.21,687.095 1315.51,689.389 C1316.94,691.525 1317.08,693.819 1315.51,696.114 C1314.07,698.551 1311.78,700.273 1308.77,700.86 C1305.9,701.576 1303.32,701.294 1300.88,700.002 C1299.16,699.27 1298.01,698.265 1297.13,696.96 C1296.25,695.826 1295.66,694.678 1295.22,693.365 C1294.63,691.525 1294.34,690.09 1294.34,688.657 C1294.34,685.38 1295.77,683.086 1300.02,684.324 M1304.74,689.659 C1305.47,692.651 1306.47,694.676 1307.77,696.251 C1309.2,697.689 1310.78,698.551 1312.64,698.404 C1313.84,698.359 1314.71,697.777 1315.3,696.772 C1316.02,695.478 1316.17,693.509 1315.59,691.214 C1315.01,688.078 1314.15,685.792 1312.71,684.498 C1311.43,683.066 1309.86,682.478 1307.85,682.624 C1305.04,682.77 1303.46,685.081 1303.46,689.803"/>
<path class="Stem" fill="none" stroke="#000000" stroke-width="0.930303" stroke-linecap="round" stroke-linejoin="round" d="M1315.88,698.406 L1315.88,626.856"/>
<path class="Beam" fill-rule="evenodd" fill="#000000" d="M1171.29,622.221 L1315.88,626.856 L1315.88,635.879 L1171.29,631.244"/>
</g>
<!-- (sama fail jätkub, aga ikoonide cropid vajavad ainult olemasolevaid elemente) -->
</g>
</g>
</g>
</symbol>
  </svg>

  <header>
    <div>
      <h1>Rütmiharjutuste generaator (beeta)</h1>
      <div class="tagline">Vali rütmid, taktimõõt ja pikkus – siis genereeri uus harjutus.</div>
    </div>
  </header>

  <div class="layout">

    <section class="card controls">
      <h2>Sisu</h2>
      <div class="rhythm-grid" style="margin-bottom: 10px;">

        <!-- ta - veerand -->
        <label class="chk" title="ta (veerand)">
          <input type="checkbox" id="tok_ta" checked />
          <svg width="54" height="40" viewBox="445 610 80 130" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path transform="matrix(0.992126,0,0,0.992126,444.986,696.26)" d="M31.5,-8.14063 C29.7031,-11.4375 25.9063,-13.2344 21.2969,-13.2344 C17.9063,-13.2344 14.2031,-12.2344 10.5938,-10.3438 C4,-6.84375 0,-0.9375 0,4.15625 C0,5.5625 0.296875,6.96875 1,8.26563 C2.79688,11.5781 6.59375,13.2813 11.2031,13.2813 C14.5938,13.2813 18.2969,12.375 21.9063,10.4844 C28.5,6.96875 32.5,1.0625 32.5,-4.04688 C32.5,-5.4375 32.2031,-6.84375 31.5,-8.14063"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="475.858,693.085 475.858,615.65"/>
          </svg>
        </label>

        <!-- ti-ti - 2 kaheksandikku -->
        <label class="chk" title="ti-ti (2×8ndik)">
          <input type="checkbox" id="tok_titi" checked />
          <svg width="60" height="40" viewBox="606 610 80 130" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path transform="matrix(0.992126,0,0,0.992126,575.177,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,616.838,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="606.049,693.085 606.049,628.051"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="647.71,693.085 647.71,628.051"/>
            <path fill-rule="evenodd" d="M604.685,621.85 L649.074,621.85 L649.074,634.252 L604.685,634.252 L604.685,621.85 "/>
          </svg>
        </label>

        <!-- ta-a-a - täisnoot -->
        <label class="chk" title="ta-a-a (täisnoot)">
          <input type="checkbox" id="tok_taaa" />
          <svg width="54" height="40" viewBox="280 610 80 130" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path transform="matrix(0.992126,0,0,0.992126,279.893,696.26)" d="M18.7031,-13.5938 C4.90625,-13.5938 0,-6.59375 0,-0.09375 C0,6.40625 4.90625,13.4063 18.7031,13.4063 C32.5,13.4063 37.2969,6.4063 37.2969,-0.09375 C37.2969,-6.59375 32.5,-13.5938 18.7031,-13.5938 M10.4063,-4.5 C10.2969,-4.90625 10.2969,-5.29688 10.2969,-5.70313 C10.2969,-6.5 10.5,-7.29688 10.9063,-8 C11.5938,-9 12.7969,-9.70313 14.2969,-10 C15.5938,-10.2969 16.2969,-10.5 18.9063,-10.5 L19,-10.5 C23,-10.5 24.2969,-6.79688 25.4063,-3 L25.7031,-2 C26.5,0.59375 26.9063,2.79688 26.9063,4.5 C26.9063,5.70313 26.7031,6.79688 26.2969,7.59375 C25.7031,8.70313 24.7031,9.40625 23,9.79688 C22.0938,10 20.5938,10.0938 20.5938,10.0938 C20.0938,10.0938 19.7031,10.2031 19.2969,10.2031 C16.0938,10.2031 14.0938,9 12.7031,4.70313 C11.5,1 11.2969,-0.09375 10.4063,-4.5"/>
          </svg>
        </label>

        <!-- ta-a-i - punkt. poolnoot (MuseScore crop) -->
        <label class="chk" title="ta-a-i (punkt. poolnoot)">
          <input type="checkbox" id="tok_taai" />
          <svg width="70" height="40" viewBox="2028.90 587.88 109.13 173.64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <use href="#ms_all"></use>
          </svg>
        </label>

        <!-- ti-ri - 4×16ndik -->
        <label class="chk" title="ti-ri (4×16ndik)">
          <input type="checkbox" id="tok_tiri" />
          <svg width="92" height="40" viewBox="1333 610 130 130" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path transform="matrix(0.992126,0,0,0.992126,1303.92,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,1341.12,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,1378.32,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,1415.51,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="1334.79,693.085 1334.79,615.65"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="1371.99,693.085 1371.99,615.65"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="1409.18,693.085 1409.18,615.65"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="1446.38,693.085 1446.38,615.65"/>
            <path fill-rule="evenodd" d="M1333.42,609.449 L1447.74,609.449 L1447.74,621.85 L1333.42,621.85 L1333.42,609.449 "/>
            <path fill-rule="evenodd" d="M1333.42,628.051 L1447.74,628.051 L1447.74,640.453 L1333.42,640.453 L1333.42,628.051 "/>
          </svg>
        </label>

        <!-- tai-ri - punkt. 8 + 16 (üks õige variant) -->
        <label class="chk" title="tai-ri (punkt. 8 + 16)">
          <input type="checkbox" id="tok_tairi" />
          <svg width="80" height="40" viewBox="356 610 310 130" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path transform="matrix(0.992126,0,0,0.992126,356.457,721.063)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,630.6,721.063)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="387.329,717.888 387.329,640.453"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="661.473,717.888 661.473,640.453"/>
            <path fill-rule="evenodd" d="M385.965,634.252 L662.837,634.252 L662.837,646.654 L385.965,646.654 L385.965,634.252 "/>
            <path fill-rule="evenodd" d="M662.837,652.854 L630.593,652.854 L630.593,665.256 L662.837,665.256 L662.837,652.854 "/>
            <path transform="matrix(0.992126,0,0,0.992126,401.095,721.063)" d="M0,0 C0,2.76563 2.23438,5 5,5 C7.76563,5 10,2.76563 10,0 C10,-2.76563 7.76563,-5 5,-5 C2.23438,-5 0,-2.76563 0,0"/>
          </svg>
        </label>

        <!-- ta-i-ti - punkt. veerand + kaheksandik (MuseScore crop) -->
        <label class="chk" title="ta-i-ti (punkt. veerand + 8ndik)">
          <input type="checkbox" id="tok_taiti" />
          <svg width="90" height="40" viewBox="2197.56 585.40 250.51 176.12" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <use href="#ms_all"></use>
          </svg>
        </label>

        <!-- triool - 3×8ndik -->
        <label class="chk" title="triool (3×8ndik)">
          <input type="checkbox" id="tok_triplet" />
          <svg width="90" height="40" viewBox="2032 570 160 180" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path transform="matrix(0.992126,0,0,0.992126,2032.1,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,2069.3,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,2106.5,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="2062.98,693.085 2062.98,621.85"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="2100.18,693.085 2100.18,621.85"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="2137.37,693.085 2137.37,621.85"/>
            <path fill-rule="evenodd" d="M2061.61,621.85 L2138.73,621.85 L2138.73,634.252 L2061.61,634.252 L2061.61,621.85 "/>
            <path d="M2103.11,588.607 C2105.23,587.935 2106.08,587.56 2107.15,586.842 C2109.28,585.451 2110.58,582.982 2110.58,580.451 C2110.58,576.185 2107.15,573.31 2102.12,573.31 C2097.22,573.31 2093.08,576.357 2093.08,580.06 C2093.08,581.904 2094.2,583.154 2095.9,583.154 C2097.39,583.154 2098.48,582.076 2098.48,580.592 C2098.48,579.826 2098.25,579.295 2097.53,578.576 C2097.08,578.17 2096.9,577.842 2096.9,577.529 C2096.9,576.451 2099.15,575.326 2101.26,575.326 C2104.28,575.326 2106.08,576.998 2106.08,579.779 C2106.08,583.795 2103.25,587.56 2100.23,587.56 C2100.09,587.56 2099.68,587.529 2099.2,587.482 C2097.89,587.389 2097.89,587.389 2097.62,587.389 C2096.62,587.389 2096.09,587.842 2096.09,588.654 C2096.09,589.373 2096.59,589.81 2097.39,589.81 C2097.62,589.81 2097.93,589.779 2098.29,589.732 C2098.92,589.592 2099.61,589.545 2100,589.545 C2102.12,589.545 2103.56,591.435 2103.56,594.232 C2103.56,596.389 2103.06,598.451 2102.08,600.17 C2100.73,602.592 2098.65,603.764 2095.73,603.764 C2093.22,603.764 2091.04,602.514 2091.04,601.06 C2091.04,600.576 2091.23,600.389 2091.95,600.076 C2093.25,599.498 2093.79,598.685 2093.79,597.467 C2093.79,595.889 2092.53,594.685 2090.92,594.685 C2088.98,594.685 2087.72,596.201 2087.72,598.545 C2087.72,602.92 2091.04,605.654 2096.45,605.654 C2103.25,605.654 2108.42,601.107 2108.42,595.076 C2108.42,593.467 2107.92,592.06 2106.98,590.935 C2105.98,589.779 2105.09,589.232 2103.11,588.607"/>
          </svg>
        </label>

        <!-- sünkoobid (pikk = 8+veerand+8) -->
        <label class="chk" title="sünkoop (lühike + pikk)">
          <input type="checkbox" id="tok_sync" />
          <!-- käsitsi joonistatud, aga mõõdud ühtlustatud teiste ikoonidega -->
          <svg width="90" height="40" viewBox="0 0 260 80" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <!-- 8th -->
            <ellipse cx="44" cy="50" rx="14" ry="10" fill="#111" transform="rotate(-20 44 50)"/>
            <rect x="56" y="12" width="2.2" height="46" fill="#111"/>
            <path d="M 58 15 C 74 22, 76 38, 60 44 C 70 40, 68 30, 58 26 Z" fill="#111"/>
            <!-- quarter -->
            <ellipse cx="130" cy="50" rx="14" ry="10" fill="#111" transform="rotate(-20 130 50)"/>
            <rect x="142" y="12" width="2.2" height="46" fill="#111"/>
            <!-- 8th -->
            <ellipse cx="216" cy="50" rx="14" ry="10" fill="#111" transform="rotate(-20 216 50)"/>
            <rect x="228" y="12" width="2.2" height="46" fill="#111"/>
            <path d="M 230 15 C 246 22, 248 38, 232 44 C 242 40, 240 30, 230 26 Z" fill="#111"/>
          </svg>
        </label>

        <!-- ti-ri-ti (16+16+8) -->
        <label class="chk" title="ti-ri-ti (16+16+8)">
          <input type="checkbox" id="tok_tiriti" />
          <svg width="70" height="40" viewBox="872 610 80 130" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path transform="matrix(0.992126,0,0,0.992126,843.204,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,880.401,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,925.039,696.26)" d="M0,0 C0,2.76563 2.23438,5 5,5 C7.76563,5 10,2.76563 10,0 C10,-2.76563 7.76563,-5 5,-5 C2.23438,-5 0,-2.76563 0,0"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="874.077,693.085 874.077,615.65"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="911.274,693.085 911.274,615.65"/>
            <path fill-rule="evenodd" d="M872.712,609.449 L912.638,609.449 L912.638,621.85 L872.712,621.85 L872.712,609.449 "/>
            <path fill-rule="evenodd" d="M872.712,628.051 L904.957,628.051 L904.957,640.453 L872.712,640.453 L872.712,628.051 "/>
          </svg>
        </label>

        <!-- ti-ti-ri (8+16+16) -->
        <label class="chk" title="ti-ti-ri (8+16+16)">
          <input type="checkbox" id="tok_titiri" />
          <svg width="80" height="40" viewBox="1886 610 110 130" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path transform="matrix(0.992126,0,0,0.992126,1886.82,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,1953.25,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,1931.46,696.26)" d="M0,0 C0,2.76563 2.23438,5 5,5 C7.76563,5 10,2.76563 10,0 C10,-2.76563 7.76563,-5 5,-5 C2.23438,-5 0,-2.76563 0,0"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="1917.7,693.085 1917.7,615.65"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="1984.12,693.085 1984.12,615.65"/>
            <path transform="matrix(0.992126,0,0,0.992126,1982.75,615.65)" d="M3.5,3.5 C3.40625,3.20313 2.5,-0.296875 2.5,-0.5 C2.40625,-0.90625 1.79688,-1.20313 1.29688,-1.20313 C0.59375,-1.20313 0,-0.59375 0,0.09375 L0,16.5 L0,22.7031 C0,23.2031 0.40625,23.5938 0.796875,23.7969 C5,25.0938 13.7031,30.6094 20.2031,41.7031 C22,44.7969 24.9063,49 24.9063,57.4063 C24.9063,64.6094 23.7969,72.2031 22,79.2031 C21.7031,80.3125 21.4063,81.3125 22.5,81.7031 C23.5938,82.1094 24,81.3125 24.4063,80.3125 C28,71.5 28.9063,62.2969 28.9063,56.1094 L28.9063,54.2031 C28.4063,41.2969 21,31.7969 21,31.7969 C21.2969,31.7969 11.7969,19.5 9.09375,15.2969 C5.40625,9.59375 3.59375,3.90625 3.5,3.5"/>
          </svg>
        </label>

        <!-- ti-ri-ti-ri (4×16 2+2) -->
        <label class="chk" title="ti-ri-ti-ri (4×16, 2+2)">
          <input type="checkbox" id="tok_tiritiri" />
          <svg width="80" height="40" viewBox="1003 610 100 130" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path transform="matrix(0.992126,0,0,0.992126,972.861,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,1014.52,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <path transform="matrix(0.992126,0,0,0.992126,1051.72,696.26)" d="M31.5,-8.09375 C29.7031,-11.4063 25.9063,-13.2031 21.2969,-13.2031 C17.9063,-13.2031 14.2031,-12.2031 10.5938,-10.2969 C4,-6.79688 0,-0.90625 0,4.20313 C0,5.59375 0.296875,7 1,8.29688 C2.79688,11.5938 6.59375,13.2969 11.2031,13.2969 C14.5938,13.2969 18.2969,12.4063 21.9063,10.5 C28.5,7 32.5,1.09375 32.5,-4 C32.5,-5.40625 32.2031,-6.79688 31.5,-8.09375"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="1003.73,693.085 1003.73,615.65"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="1045.4,693.085 1045.4,615.65"/>
            <polyline fill="none" stroke="#000000" stroke-width="2.73" points="1082.59,693.085 1082.59,615.65"/>
            <path fill-rule="evenodd" d="M1002.37,609.449 L1083.96,609.449 L1083.96,621.85 L1002.37,621.85 L1002.37,609.449 "/>
            <path fill-rule="evenodd" d="M1044.03,628.051 L1083.96,628.051 L1083.96,640.453 L1044.03,640.453 L1044.03,628.051 "/>
          </svg>
        </label>

      </div>

      <label class="chk" style="margin-bottom: 12px; justify-content:flex-start;">
        <input type="checkbox" id="incl_rests" checked />
        <span style="font-weight:600;">Lisa pausid (vastavad vältused)</span>
      </label>

      <h2>Seaded</h2>
      <div class="row" style="margin-bottom: 10px;">
        <div style="flex:1; min-width: 140px;">
          <div class="muted" style="margin: 0 0 6px;">Taktimõõt</div>
          <select id="timeSig">
            <option value="2/4">2/4</option>
            <option value="3/4">3/4</option>
            <option value="4/4" selected>4/4</option>
          </select>
        </div>
        <div style="flex:1; min-width: 140px;">
          <div class="muted" style="margin: 0 0 6px;">Pikkus</div>
          <select id="length">
            <option value="2">2 takti</option>
            <option value="4" selected>4 takti</option>
            <option value="8">8 takti</option>
          </select>
        </div>
      </div>

      <div style="margin-bottom: 10px;">
        <div class="muted" style="margin: 0 0 6px;">Harjutuste arv</div>
        <select id="numExercises" style="width: 100%;">
          <option value="1" selected>1 harjutus</option>
          <option value="2">2 harjutust</option>
          <option value="3">3 harjutust</option>
          <option value="4">4 harjutust</option>
          <option value="5">5 harjutust</option>
          <option value="6">6 harjutust</option>
        </select>
      </div>

      <div class="btnbar">
        <button id="btnGen" type="button">Genereeri</button>
        <button id="btnAgain" type="button" class="secondary">Uuesti</button>
        <button id="btnPrint" type="button" class="ghost">Print</button>
      </div>

      <div class="small">Nipp: kui midagi ei uuene, tee värskendus (Ctrl+Shift+R / Cmd+Shift+R).</div>
    </section>

    <section class="card paper">
      <div id="paper"></div>
    </section>

  </div>

  <script>
    // === UNIT SYSTEM ===
    const TICKS_PER_BEAT = 24;

    // === RHYTHM LOGIC ===
    const DUR = {
      TA: 24,           // veerand (1 beat)
      TI_TI: 24,        // 2×8ndik (1 beat)
      TI_RI: 24,        // 4×16ndik (1 beat)
      TA_A_A: 96,       // täisnoot (4 beats)
      TA_A_I: 72,       // punkt. poolnoot (3 beats)
      DOTTED_8_16: 24,  // tai-ri (18+6)
      DOTTED_Q_8: 48,   // ta-i-ti (36+12)
      TRIPLET_8: 24,    // triool (8+8+8)
      SYNC_16_8_16: 24, // lühike sünkoop (6+12+6)
      SYNC_8_Q_8: 48,   // pikk sünkoop (12+24+12)
      TI_RI_TI: 24,     // 16+16+8
      TI_TI_RI: 24,     // 8+16+16
      TI_RI_TI_RI: 24   // 16+16+16+16 (2+2 beam)
    };

    function beatsToTicks(numer, denom) {
      // 4/4: numer*24; 2/4: 2*24; 3/4: 3*24; (denom arvestatud üldiselt)
      return Math.round(numer * TICKS_PER_BEAT * (4 / denom));
    }

    function pick(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function getConfig() {
      const enabled = [];
      if (document.getElementById('tok_ta').checked) enabled.push('TA');
      if (document.getElementById('tok_titi').checked) enabled.push('TI_TI');
      if (document.getElementById('tok_tiri').checked) enabled.push('TI_RI');
      if (document.getElementById('tok_taaa').checked) enabled.push('TA_A_A');
      if (document.getElementById('tok_taai').checked) enabled.push('TA_A_I');
      if (document.getElementById('tok_tairi').checked) enabled.push('DOTTED_8_16');
      if (document.getElementById('tok_taiti').checked) enabled.push('DOTTED_Q_8');
      if (document.getElementById('tok_triplet').checked) enabled.push('TRIPLET_8');
      if (document.getElementById('tok_sync').checked) {
        enabled.push('SYNC_16_8_16');
        enabled.push('SYNC_8_Q_8');
        enabled.push('SYNC_8_Q_8'); // 2× = natuke tõenäolisem
      }
      if (document.getElementById('tok_tiriti').checked) enabled.push('TI_RI_TI');
      if (document.getElementById('tok_titiri').checked) enabled.push('TI_TI_RI');
      if (document.getElementById('tok_tiritiri').checked) enabled.push('TI_RI_TI_RI');

      const includeRests = document.getElementById('incl_rests').checked;
      const ts = document.getElementById('timeSig').value;
      const parts = ts.split('/').map(x => parseInt(x, 10));
      const numer = parts[0];
      const denom = parts[1];
      const measures = parseInt(document.getElementById('length').value, 10);
      const numExercises = parseInt(document.getElementById('numExercises').value, 10);

      return { enabled, includeRests, numer, denom, measures, numExercises };
    }

    function generateMeasure(cfg) {
      const total = beatsToTicks(cfg.numer, cfg.denom);
      let left = total;
      const out = [];

      const choices = [];
      for (const t of cfg.enabled) {
        const d = DUR[t] ?? DUR.TA;
        choices.push({ kind: 'note', type: t, dur: d });
        if (cfg.includeRests) {
          choices.push({ kind: 'rest', type: 'REST', dur: d });
        }
      }

      if (choices.length === 0) choices.push({ kind: 'note', type: 'TA', dur: DUR.TA });

      for (let guard = 0; guard < 400 && left > 0; guard++) {
        const possible = choices.filter(c => c.dur <= left);
        if (possible.length === 0) break;

        let next = pick(possible);

        // Ei alusta takti pausiga
        if (out.length === 0 && next.kind === 'rest') {
          const nonRests = possible.filter(c => c.kind === 'note');
          if (nonRests.length) next = pick(nonRests);
        }

        // Ei pane pausid järjest
        const last = out[out.length - 1];
        if (last && last.kind === 'rest' && next.kind === 'rest') {
          const nonRests = possible.filter(c => c.kind === 'note');
          if (nonRests.length) next = pick(nonRests);
        }

        out.push(next);
        left -= next.dur;
      }

      // Täidame ülejäänud veeranditega
      while (left > 0) {
        if (left >= DUR.TA) {
          out.push({ kind: 'note', type: 'TA', dur: DUR.TA });
          left -= DUR.TA;
        } else {
          left = 0;
        }
      }

      return out;
    }

    function generateExercise(cfg) {
      const measures = [];
      for (let i = 0; i < cfg.measures; i++) measures.push(generateMeasure(cfg));
      return measures;
    }

    // === SVG RENDER ===
    function svgEl(tag, attrs) {
      const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
      if (attrs) {
        for (const k in attrs) el.setAttribute(k, String(attrs[k]));
      }
      return el;
    }

    function drawNotehead(svg, cx, cy, filled) {
      const e = svgEl('ellipse', {
        cx: cx,
        cy: cy,
        rx: 7.8,
        ry: 5.7,
        stroke: '#111',
        'stroke-width': 1.8,
        fill: filled ? '#111' : 'none'
      });
      e.setAttribute('transform', 'rotate(-20 ' + cx + ' ' + cy + ')');
      svg.appendChild(e);
    }

    function drawDot(svg, x, y) {
      svg.appendChild(svgEl('circle', { cx: x, cy: y, r: 2.3, fill: '#111' }));
    }

    function drawStemUp(svg, xRightOfHead, headY, stemH) {
      svg.appendChild(svgEl('rect', {
        x: xRightOfHead,
        y: headY - stemH,
        width: 2.2,
        height: stemH,
        fill: '#111'
      }));
    }

    function drawFlag(svg, xStem, yTop, isSixteenth) {
      const p1 = svgEl('path', {
        d: 'M ' + (xStem+2) + ' ' + (yTop+2) +
           ' C ' + (xStem+14) + ' ' + (yTop+6) + ', ' + (xStem+16) + ' ' + (yTop+18) + ', ' + (xStem+4) + ' ' + (yTop+22) +
           ' C ' + (xStem+12) + ' ' + (yTop+18) + ', ' + (xStem+10) + ' ' + (yTop+10) + ', ' + (xStem+2) + ' ' + (yTop+8) +
           ' Z',
        fill: '#111'
      });
      svg.appendChild(p1);

      if (isSixteenth) {
        const y2 = yTop + 10;
        const p2 = svgEl('path', {
          d: 'M ' + (xStem+2) + ' ' + (y2+2) +
             ' C ' + (xStem+14) + ' ' + (y2+6) + ', ' + (xStem+16) + ' ' + (y2+18) + ', ' + (xStem+4) + ' ' + (y2+22) +
             ' C ' + (xStem+12) + ' ' + (y2+18) + ', ' + (xStem+10) + ' ' + (y2+10) + ', ' + (xStem+2) + ' ' + (y2+8) +
             ' Z',
          fill: '#111'
        });
        svg.appendChild(p2);
      }
    }

    const GLYPH_REST_QUARTER = String.fromCodePoint(0x1D13D);
    const GLYPH_REST_EIGHTH = String.fromCodePoint(0x1D13E);
    const GLYPH_REST_SIXTEENTH = String.fromCodePoint(0x1D13F);

    function drawRest(svg, cx, cy, durTicks) {
      const xOpt = cx + 6;

      if (durTicks >= 48) {
        const w = 22;
        const h = 8;
        const y = cy - 18;
        svg.appendChild(svgEl('rect', { x: xOpt - w/2, y: y, width: w, height: h, fill: '#111', rx: 2 }));
        svg.appendChild(svgEl('line', {
          x1: xOpt - (w/2) - 6,
          y1: y,
          x2: xOpt + (w/2) + 6,
          y2: y,
          stroke: '#111',
          'stroke-width': 2
        }));
        return;
      }

      let glyph = GLYPH_REST_QUARTER;
      if (durTicks === 12) glyph = GLYPH_REST_EIGHTH;
      if (durTicks === 6) glyph = GLYPH_REST_SIXTEENTH;

      const t = svgEl('text', {
        x: xOpt,
        y: cy - 10,
        'text-anchor': 'middle',
        'dominant-baseline': 'middle',
        'font-size': 40,
        'font-family': 'Bravura, "Noto Music", "Segoe UI Symbol", "Arial Unicode MS", serif',
        fill: '#111'
      });
      t.textContent = glyph;
      svg.appendChild(t);
    }

    function beatGrid(cfg, x0, x1, isLastMeasure) {
      const padL = 4;
      const padR = isLastMeasure ? 18 : 12;
      const innerX0 = x0 + padL;
      const innerX1 = x1 - padR;
      const beats = cfg.numer * (4 / cfg.denom);
      const beatW = (innerX1 - innerX0) / beats;
      return { innerX0, innerX1, beatW, beats };
    }

    function centersFromParts(spanX0, spanW, partsTicks, pad) {
      const total = partsTicks.reduce((a,b)=>a+b,0);
      const usable = Math.max(0, spanW - pad*2);
      let cur = 0;
      return partsTicks.map(d => {
        const c = spanX0 + pad + (cur + d/2) * (usable / total);
        cur += d;
        return c;
      });
    }

    function drawTripletBracket(svg, xA, xB, y, label) {
      const h = 8;
      svg.appendChild(svgEl('line', { x1: xA, y1: y, x2: xB, y2: y, stroke: '#111', 'stroke-width': 1.6 }));
      svg.appendChild(svgEl('line', { x1: xA, y1: y, x2: xA, y2: y + h, stroke: '#111', 'stroke-width': 1.6 }));
      svg.appendChild(svgEl('line', { x1: xB, y1: y, x2: xB, y2: y + h, stroke: '#111', 'stroke-width': 1.6 }));
      const t = svgEl('text', { x: (xA+xB)/2, y: y - 2, 'text-anchor': 'middle', 'font-size': 22, 'font-family': 'serif', fill: '#111' });
      t.textContent = label || '3';
      svg.appendChild(t);
    }

    function renderMultipleExercises(cfg) {
      const paper = document.getElementById('paper');
      paper.innerHTML = '';

      const numEx = cfg.numExercises || 1;

      for (let exNum = 1; exNum <= numEx; exNum++) {
        const titleDiv = document.createElement('div');
        titleDiv.style.fontSize = '1.2rem';
        titleDiv.style.fontWeight = 'bold';
        titleDiv.style.marginTop = exNum > 1 ? '34px' : '6px';
        titleDiv.style.marginBottom = '10px';
        titleDiv.textContent = numEx > 1 ? `Harjutus ${exNum}` : '';
        paper.appendChild(titleDiv);

        const measures = generateExercise(cfg);
        renderSingleExercise(cfg, measures, paper);
      }
    }

    function renderSingleExercise(cfg, measures, container) {
      const marginLeft = 58;
      const marginTop = 24;
      const rowMeasures = 4;
      const measureW = 320;
      const gap = 16;
      const rowGapY = 110;
      const rightPad = 28;

      const rows = Math.ceil(measures.length / rowMeasures);
      const cols = Math.min(rowMeasures, measures.length);

      const W = marginLeft + cols * (measureW + gap) - gap + rightPad;
      const H = 170 + (rows - 1) * 130;

      const svg = svgEl('svg', { width: W, height: H, viewBox: '0 0 ' + W + ' ' + H });
      svg.style.width = '100%';
      svg.style.height = 'auto';
      container.appendChild(svg);

      const topY = 38;
      const bottomY = 116;
      const noteY = 80;
      const stemH = 38;

      function drawTimeSigAtRow(yRow0) {
        const tsX = 18;
        const tsTop = svgEl('text', { x: tsX, y: yRow0 + 78, 'font-size': 30, 'font-family': 'serif', fill: '#111' });
        tsTop.textContent = String(cfg.numer);
        const tsBottom = svgEl('text', { x: tsX, y: yRow0 + 106, 'font-size': 30, 'font-family': 'serif', fill: '#111' });
        tsBottom.textContent = String(cfg.denom);
        svg.appendChild(tsTop);
        svg.appendChild(tsBottom);
      }

      function drawBarline(x, y0) {
        svg.appendChild(svgEl('line', { x1: x, y1: y0 + topY, x2: x, y2: y0 + bottomY, stroke: '#111', 'stroke-width': 2 }));
      }

      function drawFinalBarline(x, y0) {
        svg.appendChild(svgEl('line', { x1: x, y1: y0 + topY, x2: x, y2: y0 + bottomY, stroke: '#111', 'stroke-width': 2 }));
        svg.appendChild(svgEl('line', { x1: x + 6, y1: y0 + topY, x2: x + 6, y2: y0 + bottomY, stroke: '#111', 'stroke-width': 5 }));
      }

      const totalTicks = beatsToTicks(cfg.numer, cfg.denom);
      const TPB = TICKS_PER_BEAT;

      const PAD_TITI = 6;
      const PAD_TIRI = 6;
      const PAD_TRIP = 2;
      const PAD_DOTTED = 5;
      const PAD_DOTTED_LONG = 8;
      const PAD_SYNC = 4;

      for (let i = 0; i < measures.length; i++) {
        const row = Math.floor(i / rowMeasures);
        const col = i % rowMeasures;

        const y0 = marginTop + row * rowGapY;
        const x0 = marginLeft + col * (measureW + gap);
        const x1 = x0 + measureW;

        if (col === 0) drawTimeSigAtRow(y0);

        const isLast = (i === measures.length - 1);
        if (isLast) drawFinalBarline(x1, y0);
        else drawBarline(x1, y0);

        const grid = beatGrid(cfg, x0, x1, isLast);
        const tokens = measures[i];

        let cursor = 0;
        for (const tok of tokens) {
          const startBeat = cursor / TPB;
          const spanBeats = tok.dur / TPB;

          const spanX0 = grid.innerX0 + startBeat * grid.beatW;
          const spanW = spanBeats * grid.beatW;

          let parts;
          if (tok.kind === 'rest') {
            parts = [{ kind: 'rest', ticks: tok.dur, optional: true }];
          } else if (tok.type === 'TA') {
            parts = [{ kind: 'note', ticks: DUR.TA }];
          } else if (tok.type === 'TA_A_A') {
            parts = [{ kind: 'note', ticks: DUR.TA_A_A }];
          } else if (tok.type === 'TA_A_I') {
            parts = [{ kind: 'note', ticks: DUR.TA_A_I, dotted: true }];
          } else if (tok.type === 'TI_TI') {
            parts = [
              { kind: 'note', ticks: 12, level: 1 },
              { kind: 'note', ticks: 12, level: 1 }
            ];
          } else if (tok.type === 'TI_RI') {
            parts = [
              { kind: 'note', ticks: 6, level: 2 },
              { kind: 'note', ticks: 6, level: 2 },
              { kind: 'note', ticks: 6, level: 2 },
              { kind: 'note', ticks: 6, level: 2 }
            ];
          } else if (tok.type === 'DOTTED_8_16') {
            parts = [
              { kind: 'note', ticks: 18, dotted: true, level: 1 },
              { kind: 'note', ticks: 6, level: 2 }
            ];
          } else if (tok.type === 'DOTTED_Q_8') {
            parts = [
              { kind: 'note', ticks: 36, dotted: true, level: 0 },
              { kind: 'note', ticks: 12, level: 1, forceFlag: true }
            ];
          } else if (tok.type === 'TRIPLET_8') {
            parts = [
              { kind: 'note', ticks: 8, level: 1 },
              { kind: 'note', ticks: 8, level: 1 },
              { kind: 'note', ticks: 8, level: 1 }
            ];
          } else if (tok.type === 'SYNC_16_8_16') {
            parts = [
              { kind: 'note', ticks: 6, level: 2 },
              { kind: 'note', ticks: 12, level: 1 },
              { kind: 'note', ticks: 6, level: 2 }
            ];
          } else if (tok.type === 'SYNC_8_Q_8') {
            parts = [
              { kind: 'note', ticks: 12, level: 1, forceFlag: true },
              { kind: 'note', ticks: 24, level: 0 },
              { kind: 'note', ticks: 12, level: 1, forceFlag: true }
            ];
          } else if (tok.type === 'TI_RI_TI') {
            parts = [
              { kind: 'note', ticks: 6, level: 2 },
              { kind: 'note', ticks: 6, level: 2 },
              { kind: 'note', ticks: 12, level: 1 }
            ];
          } else if (tok.type === 'TI_TI_RI') {
            parts = [
              { kind: 'note', ticks: 12, level: 1 },
              { kind: 'note', ticks: 6, level: 2 },
              { kind: 'note', ticks: 6, level: 2 }
            ];
          } else if (tok.type === 'TI_RI_TI_RI') {
            parts = [
              { kind: 'note', ticks: 6, level: 2 },
              { kind: 'note', ticks: 6, level: 2 },
              { kind: 'note', ticks: 6, level: 2 },
              { kind: 'note', ticks: 6, level: 2 }
            ];
          } else {
            parts = [{ kind: 'note', ticks: tok.dur }];
          }

          const pad = (
            tok.type === 'TI_TI' ? PAD_TITI :
            tok.type === 'TI_RI' ? PAD_TIRI :
            tok.type === 'TRIPLET_8' ? PAD_TRIP :
            tok.type === 'DOTTED_8_16' ? PAD_DOTTED :
            tok.type === 'DOTTED_Q_8' ? PAD_DOTTED_LONG :
            tok.type === 'SYNC_16_8_16' ? PAD_SYNC :
            tok.type === 'SYNC_8_Q_8' ? PAD_SYNC :
            6
          );

          const centers = (parts.length === 1)
            ? [spanX0 + spanW/2]
            : centersFromParts(spanX0, spanW, parts.map(p => p.ticks), pad);

          const stemXs = [];
          const stemTopY = y0 + noteY - stemH;

          for (let pi = 0; pi < parts.length; pi++) {
            const p = parts[pi];
            const cx = centers[pi];

            if (p.kind === 'rest') {
              if (!p.optional || p.required || cfg.includeRests) {
                drawRest(svg, cx, y0 + noteY, p.ticks);
              }
              continue;
            }

            const isHollow = (p.ticks >= 48) || (tok.type === 'TA_A_A') || (tok.type === 'TA_A_I');
            const filled = !isHollow;
            drawNotehead(svg, cx, y0 + noteY, filled);

            // Täisnoot ei vaja varsi
            if (tok.type !== 'TA_A_A') {
              drawStemUp(svg, cx + 6, y0 + noteY, stemH);
              stemXs.push(cx + 6);
            }

            if (p.dotted) drawDot(svg, cx + 14, y0 + noteY - 2);

            if (p.forceFlag) {
              drawFlag(svg, cx + 6, stemTopY, false);
            }
          }

          const beamY = stemTopY;
          function beamLine(xA, xB, y, thickness) {
            svg.appendChild(svgEl('rect', { x: xA, y: y, width: (xB - xA), height: (thickness || 6), fill: '#111' }));
          }

          if (tok.type === 'TI_TI' && stemXs.length === 2) {
            beamLine(stemXs[0], stemXs[1] + 2, beamY, 6);
          }

          if (tok.type === 'TI_RI' && stemXs.length === 4) {
            beamLine(stemXs[0], stemXs[3] + 2, beamY, 6);
            beamLine(stemXs[0], stemXs[3] + 2, beamY + 9, 6);
          }

          if (tok.type === 'TRIPLET_8' && stemXs.length === 3) {
            beamLine(stemXs[0], stemXs[2] + 2, beamY, 6);
            const xA = centers[0] - 10;
            const xB = centers[2] + 10;
            drawTripletBracket(svg, xA, xB, beamY - 18, '3');
          }

          if (tok.type === 'DOTTED_8_16' && stemXs.length === 2) {
            beamLine(stemXs[0], stemXs[1] + 2, beamY, 6);
            beamLine(stemXs[1] - 10, stemXs[1] + 2, beamY + 9, 6);
          }

          if (tok.type === 'SYNC_16_8_16' && stemXs.length === 3) {
            beamLine(stemXs[0], stemXs[2] + 2, beamY, 6);
            beamLine(stemXs[0] + 1, stemXs[0] + 7, beamY + 9, 6);
            beamLine(stemXs[2] - 6, stemXs[2] + 2, beamY + 9, 6);
          }

          if (tok.type === 'TI_RI_TI' && stemXs.length === 3) {
            beamLine(stemXs[0], stemXs[2] + 2, beamY, 6);
            beamLine(stemXs[0], stemXs[1] + 2, beamY + 9, 6);
          }

          if (tok.type === 'TI_TI_RI' && stemXs.length === 3) {
            beamLine(stemXs[0], stemXs[2] + 2, beamY, 6);
            beamLine(stemXs[1], stemXs[2] + 2, beamY + 9, 6);
          }

          if (tok.type === 'TI_RI_TI_RI' && stemXs.length === 4) {
            beamLine(stemXs[0], stemXs[3] + 2, beamY, 6);
            beamLine(stemXs[0], stemXs[1] + 2, beamY + 9, 6);
            beamLine(stemXs[2], stemXs[3] + 2, beamY + 9, 6);
          }

          cursor += tok.dur;
        }

        if (cursor !== totalTicks) {
          console.error('Takti ticks ei klapi', { i: i, cursor: cursor, totalTicks: totalTicks });
        }
      }
    }

    function formatErrorText(err) {
      const msg = (err && err.message) ? err.message : String(err);
      const stack = (err && err.stack) ? err.stack : '';
      return 'Viga: ' + msg + '

' + stack;
    }

    function showError(err) {
      const paper = document.getElementById('paper');
      paper.innerHTML = '';
      const pre = document.createElement('pre');
      pre.style.whiteSpace = 'pre-wrap';
      pre.style.padding = '12px';
      pre.style.color = '#111';
      pre.textContent = formatErrorText(err);
      paper.appendChild(pre);
    }

    let lastCfg = null;

    function generateAndRender() {
      try {
        const cfg = getConfig();
        lastCfg = cfg;
        renderMultipleExercises(cfg);
      } catch (err) {
        console.error(err);
        showError(err);
      }
    }

    function again() {
      try {
        if (!lastCfg) return generateAndRender();
        renderMultipleExercises(lastCfg);
      } catch (err) {
        console.error(err);
        showError(err);
      }
    }

    function printPage() {
      window.print();
    }

    document.getElementById('btnGen').addEventListener('click', (e) => { e.preventDefault(); generateAndRender(); });
    document.getElementById('btnAgain').addEventListener('click', (e) => { e.preventDefault(); again(); });
    document.getElementById('btnPrint').addEventListener('click', (e) => { e.preventDefault(); printPage(); });

    window.addEventListener('error', (e) => {
      try { showError(e && e.error ? e.error : e); } catch (_) {}
    });

    generateAndRender();
  </script>

</body>
</html>
